<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø¯ÙØ§ØªØ± Ø´ÛŒÙØª Ø¬Ø§Ø±ÛŒ</title>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
<style>
 /* ØªÙ… Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ Ùˆ Ù…Ø¯Ø±Ù† */
 :root { --bg:#f3f4f6; --card:#fff; --text:#111827; --accent:#6366f1; --border:#d1d5db; --thead:#f9fafb; }
 body.theme-dark { --bg:#030712; --card:#1f2937; --text:#f9fafb; --accent:#818cf8; --border:#374151; --thead:#111827; }
 body.theme-dark tr:hover td{background:#1e1b4b !important;}
 body{font-family:'Vazirmatn',Tahoma,sans-serif;background:var(--bg);margin:0;padding:1.2rem;color:var(--text);transition:.3s;}
 .wrap{max-width:1500px;margin:0 auto;}
 h1{margin:0 0 1rem;font-size:1.4rem;font-weight:800;}
 .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;}
 .tab-btn{cursor:pointer;border:none;padding:.7rem 1.2rem;font-family:inherit;font-size:.85rem;font-weight:700;border-radius:8px;background:#e2e8f0;color:#334155;transition:.15s;}
 .tab-btn.active{background:#4f46e5;color:#fff;box-shadow:0 3px 8px -2px rgba(79,70,229,.4);}
 body.theme-dark .tab-btn{background:#334155;color:#cbd5e1;}
 body.theme-dark .tab-btn.active{background:#6366f1;color:#fff;}
 .sub-tabs{display:flex;gap:.4rem;margin:.4rem 0 .6rem;}
 .sub-tab-btn{cursor:pointer;border:none;padding:.5rem 1rem;font-family:inherit;font-size:.8rem;font-weight:700;border-radius:7px;background:#e2e8f0;color:#334155;transition:.15s;}
 .sub-tab-btn.active{background:#4f46e5;color:#fff;box-shadow:0 3px 6px -2px rgba(79,70,229,.45);}
 body.theme-dark .sub-tab-btn{background:#334155;color:#cbd5e1;}
 body.theme-dark .sub-tab-btn.active{background:#6366f1;color:#fff;}
 .panel{display:none;animation:fade .25s ease;}
 .panel.active{display:block;}
 @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);} }
 table{width:100%;border-collapse:separate;border-spacing:0;}
 th{background:var(--thead);font-weight:700;font-size:.9rem;padding:.7rem .6rem;text-align:right;border-bottom:2px solid var(--border);color:#64748b;white-space:nowrap;}
 td{padding:.65rem .6rem;font-size:.95rem;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text);}
 tr:hover td{background:#f1f5f9;}
 .badge{padding:.3rem .65rem;border-radius:6px;background:#eef2ff;color:#4f46e5;font-size:.8rem;font-weight:700;}
 body.theme-dark .badge{background:#3730a3;color:#c7d2fe;}
 .summary{display:flex;gap:.8rem;flex-wrap:wrap;margin:.6rem 0 1rem;}
 .sum-box{background:var(--card);border:1px solid var(--border);padding:.7rem .9rem;border-radius:10px;display:flex;flex-direction:column;gap:.2rem;min-width:130px;color:var(--text);}
 .sum-box span:first-child{font-size:.75rem;color:#64748b;font-weight:600;}
 .sum-val{font-size:1.1rem;font-weight:800;}
 .empty{text-align:center;padding:2rem;color:#64748b;font-size:.9rem;}
 .top-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.8rem;margin-bottom:.5rem;}
 .btn{cursor:pointer;background:#4f46e5;color:#fff;border:none;padding:.6rem 1.1rem;font-family:inherit;font-size:.8rem;border-radius:8px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;}
 .btn.outline{background:#fff;color:#4f46e5;border:1px solid #4f46e5;}
 body.theme-dark .btn.outline{background:#1e293b;color:#a5b4fc;border-color:#6366f1;}
 .btn-details{cursor:pointer;background:#10b981;color:#fff;border:none;padding:.4rem .7rem;font-family:inherit;font-size:.75rem;border-radius:6px;font-weight:600;}
 .btn-details:hover{background:#059669;}
 /* Modal Styles */
 .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center;}
 .modal-overlay.active{display:flex;}
 .modal{background:var(--card);border-radius:12px;max-width:900px;width:95%;max-height:85vh;overflow:auto;box-shadow:0 20px 40px rgba(0,0,0,.3);}
 .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;border-bottom:1px solid var(--border);background:var(--thead);border-radius:12px 12px 0 0;}
 .modal-header h2{margin:0;font-size:1.1rem;font-weight:800;}
 .modal-close{cursor:pointer;background:#ef4444;color:#fff;border:none;width:32px;height:32px;border-radius:50%;font-size:1.2rem;font-weight:700;display:flex;align-items:center;justify-content:center;}
 .modal-body{padding:1.2rem;}
 .detail-row{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border);}
 .detail-item{min-width:140px;}
 .detail-label{font-size:.75rem;color:#64748b;font-weight:600;margin-bottom:.2rem;}
 .detail-value{font-size:.95rem;font-weight:700;color:var(--text);}
 .items-section{margin-top:1rem;}
 .items-section h3{font-size:.95rem;font-weight:700;margin:0 0 .6rem;color:#64748b;}
 .item-card{background:var(--thead);border:1px solid var(--border);border-radius:8px;padding:.8rem;margin-bottom:.5rem;}
 .item-type{font-size:.7rem;padding:.2rem .5rem;border-radius:4px;background:#4f46e5;color:#fff;font-weight:700;display:inline-block;margin-bottom:.4rem;}
 .item-type.visit{background:#10b981;}
 .item-type.injection{background:#f59e0b;}
 .item-type.procedure{background:#8b5cf6;}
 .item-type.consumable{background:#ec4899;}
 .item-details{display:flex;flex-wrap:wrap;gap:1rem;font-size:.85rem;}
 .item-details span{color:#64748b;}
 .item-details strong{color:var(--text);}
 .financials-box{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border-radius:10px;padding:1rem;margin-top:1rem;}
 .financials-box h4{margin:0 0 .6rem;font-size:.9rem;font-weight:700;}
 .fin-row{display:flex;justify-content:space-between;padding:.3rem 0;font-size:.9rem;}
 .fin-row.total{border-top:1px solid rgba(255,255,255,.3);margin-top:.5rem;padding-top:.5rem;font-weight:800;font-size:1rem;}
</style>
</head>
<body>
 <div class="wrap">
  <div class="top-bar">
    <h1>Ø¯ÙØ§ØªØ± Ø´ÛŒÙØª Ø¬Ø§Ø±ÛŒ</h1>
    <div style="display:flex;gap:.5rem;">
      <a class="btn outline" href="{{ url_for('reception.index') }}">â¬… Ø¨Ø§Ø²Ú¯Ø´Øª</a>
      <button class="btn" onclick="window.print()">ğŸ–¨ Ú†Ø§Ù¾ ØµÙØ­Ù‡</button>
      <button id="themeToggleLedgers" class="btn outline" style="font-weight:700;">ğŸŒ™ ØªÙ… Ø´Ø¨</button>
    </div>
  </div>
  <div style="font-size:.85rem;color:#64748b;margin-bottom:.8rem;">Ø´ÛŒÙØª: <strong style="color:var(--text);">{{ 'ØµØ¨Ø­' if shift=='morning' else ('Ø¹ØµØ±' if shift=='evening' else 'Ø´Ø¨') }}</strong> | Ø¨Ø§Ø²Ù‡: {{ start | jalali_local }} ØªØ§ {{ end | jalali_local }}</div>
  <div class="tabs">
    <button class="tab-btn active" data-tab="invoices">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</button>
    <button class="tab-btn" data-tab="visits">ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§</button>
    <button class="tab-btn" data-tab="nursing">Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</button>
    <button class="tab-btn" data-tab="procedures">Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ</button>
    <button class="tab-btn" data-tab="consumables">Ù…ØµØ±ÙÛŒâ€ŒÙ‡Ø§</button>
  </div>

  <!-- Invoices Panel -->
  <div id="panel-invoices" class="panel active">
    {% if invoices %}
    <div class="summary">
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</span><div class="sum-val">{{ invoices|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ú©Ù„ (Øª)</span><div class="sum-val">{{ invoices|sum(attribute='total_amount')|int | fa_num }}</div></div>
    </div>
    <div style="overflow:auto;max-height:60vh;">
      <table>
        <thead><tr><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ</th><th>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù¾Ø±Ø³ØªØ§Ø±Ø§Ù†</th><th>Ù¾Ø°ÛŒØ±Ø´</th><th>Ø¬Ù…Ø¹ Ú©Ù„</th><th>Ø²Ù…Ø§Ù† Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†</th><th>Ø²Ù…Ø§Ù† Ø¨Ø³ØªÙ†</th><th>Ø¬Ø²Ø¦ÛŒØ§Øª</th></tr></thead>
        <tbody>
        {% for r in invoices %}
          <tr>
            <td style="font-weight:700;">#{{ r.id }}</td>
            <td style="font-weight:600;">{{ r.patient_name }}</td>
            <td><span class="badge">{{ r.insurance_type or 'Ø¢Ø²Ø§Ø¯' }}</span></td>
            <td>{{ r.supplementary_insurance or 'â€”' }}</td>
            <td>{{ r.doctor_name or 'â€”' }}</td>
            <td style="max-width:200px; white-space:normal;">{{ r.all_nurses_names or r.nurse_name or 'â€”' }}</td>
            <td>{{ r.opened_by_name or r.opened_by or 'â€”' }}</td>
            <td style="font-weight:700;">{{ (r.total_amount or 0)|int | fa_num }}</td>
            <td>{{ r.opened_at | jalali_datetime }}</td>
            <td>{{ r.closed_at | jalali_datetime }}</td>
            <td><button class="btn-details" onclick="showInvoiceDetails({{ r.id }})">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button></td>
          </tr>
        {% endfor %}
        </tbody></table>
    </div>
    {% else %}<div class="empty">ÙØ§Ú©ØªÙˆØ± Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
  </div>

  <!-- Visits Panel -->
  <div id="panel-visits" class="panel">
    {% if visits %}
    <div class="summary">
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ²ÛŒØª</span><div class="sum-val">{{ visits|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ù…Ø¨Ø§Ù„Øº (Øª)</span><div class="sum-val">{{ visits|sum(attribute='total_amount')|int | fa_num }}</div></div>
    </div>
    <div style="overflow:auto;max-height:60vh;">
      <table>
        <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ</th><th>Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù…Ø¨Ù„Øº</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
        <tbody>
        {% for r in visits %}
          <tr>
            <td>{{ r.visit_date | jalali_datetime }}</td>
            <td style="font-weight:600;">{{ r.patient_name }}</td>
            <td><span class="badge">{{ r.insurance_type or 'Ø¢Ø²Ø§Ø¯' }}</span></td>
            <td>{{ r.supplementary_insurance or 'â€”' }}</td>
            <td>{{ r.doctor_name or r.shift_doctor_name or 'â€”' }}</td>
            <td style="font-weight:700;">{{ (r.total_amount or 0)|int | fa_num }}</td>
            <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
          </tr>
        {% endfor %}
        </tbody></table>
    </div>
    {% else %}<div class="empty">ÙˆÛŒØ²ÛŒØªÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
  </div>

  <!-- Nursing Panel -->
  <div id="panel-nursing" class="panel">
    {% if injections %}
    <div class="summary">
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª (Ù‡Ù…Ù‡)</span><div class="sum-val">{{ injections|length }}</div></div>
      <div class="sum-box"><span>Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº (Ù‡Ù…Ù‡ØŒ Øª)</span><div class="sum-val">{{ injections|sum(attribute='total_price')|int | fa_num }}</div></div>
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ø²Ø´Ú©</span><div class="sum-val">{{ (injections_doctor or [])|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ù…Ø¨Ø§Ù„Øº Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ø²Ø´Ú© (Øª)</span><div class="sum-val">{{ (injections_doctor or [])|sum(attribute='total_price')|int | fa_num }}</div></div>
    </div>

    <div class="sub-tabs">
      <button class="sub-tab-btn active" data-sub="nursing-all">Ù‡Ù…Ù‡ Ø®Ø¯Ù…Ø§Øª</button>
      <button class="sub-tab-btn" data-sub="nursing-doctor">Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ø²Ø´Ú©</button>
    </div>

    <div id="sub-panel-nursing-all" class="sub-panel">
      <div style="overflow:auto;max-height:60vh;">
        <table>
          <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯</th><th>Ù…Ø¨Ù„Øº Ú©Ù„</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù¾Ø±Ø³ØªØ§Ø±</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
          <tbody>
          {% for r in injections %}
            <tr>
              <td>{{ r.injection_date | jalali_datetime }}</td>
              <td style="font-weight:600;">{{ r.patient_name }}</td>
              <td><span class="badge">{{ r.injection_type }}</span></td>
              <td>{{ r.count }}</td>
              <td>{{ (r.unit_price or 0)|int | fa_num }}</td>
              <td style="font-weight:700;">{{ (r.total_price or 0)|int | fa_num }}</td>
              <td>{{ r.doctor_name or 'â€”' }}</td>
              <td>{{ r.nurse_name or 'â€”' }}</td>
              <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
            </tr>
          {% endfor %}
          </tbody></table>
      </div>
    </div>

    <div id="sub-panel-nursing-doctor" class="sub-panel" style="display:none;">
      {% if injections_doctor %}
      <div style="overflow:auto;max-height:60vh;">
        <table>
          <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯</th><th>Ù…Ø¨Ù„Øº Ú©Ù„</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù¾Ø±Ø³ØªØ§Ø±</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
          <tbody>
          {% for r in injections_doctor %}
            <tr>
              <td>{{ r.injection_date | jalali_datetime }}</td>
              <td style="font-weight:600;">{{ r.patient_name }}</td>
              <td><span class="badge">{{ r.injection_type }}</span></td>
              <td>{{ r.count }}</td>
              <td>{{ (r.unit_price or 0)|int | fa_num }}</td>
              <td style="font-weight:700;">{{ (r.total_price or 0)|int | fa_num }}</td>
              <td>{{ r.doctor_name or 'â€”' }}</td>
              <td>{{ r.nurse_name or 'â€”' }}</td>
              <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
            </tr>
          {% endfor %}
          </tbody></table>
      </div>
      {% else %}<div class="empty">Ø®Ø¯Ù…ØªÛŒ Ú©Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¢Ù† ÙˆÛŒØ²ÛŒØª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø± Ø§ÛŒÙ† Ø´ÛŒÙØª Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>{% endif %}
    </div>
    {% else %}<div class="empty">Ø®Ø¯Ù…Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
  </div>

  <!-- Procedures Panel -->
  <div id="panel-procedures" class="panel">
    {% if procedures %}
    <div class="summary">
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ</span><div class="sum-val">{{ procedures|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ù‚ÛŒÙ…Øª (Øª)</span><div class="sum-val">{{ procedures|sum(attribute='price')|int | fa_num }}</div></div>
    </div>
    <div style="overflow:auto;max-height:60vh;">
      <table>
        <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù†ÙˆØ¹ Ú©Ø§Ø±</th><th>Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ù†Ø¯Ù‡</th><th>Ù¾Ø²Ø´Ú© Ø´ÛŒÙØª</th><th>Ù¾Ø±Ø³ØªØ§Ø± Ø´ÛŒÙØª</th><th>Ù‚ÛŒÙ…Øª</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
        <tbody>
        {% for r in procedures %}
          <tr>
            <td>{{ r.procedure_date | jalali_datetime }}</td>
            <td style="font-weight:600;">{{ r.patient_name }}</td>
            <td><span class="badge">{{ r.procedure_type }}</span></td>
            <td>{{ 'Ù¾Ø²Ø´Ú©' if r.performer_type=='doctor' else ('Ù¾Ø±Ø³ØªØ§Ø±' if r.performer_type=='nurse' else 'â€”') }}</td>
            <td>{{ r.doctor_name or 'â€”' }}</td>
            <td>{{ r.nurse_name or 'â€”' }}</td>
            <td style="font-weight:700;">{{ (r.price or 0)|int | fa_num }}</td>
            <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
          </tr>
        {% endfor %}
        </tbody></table>
    </div>
    {% else %}<div class="empty">Ú©Ø§Ø± Ø¹Ù…Ù„ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
  </div>

  <!-- Consumables Panel -->
  <div id="panel-consumables" class="panel">
    {% set supplies = consumables | selectattr('category','equalto','supply') | list %}
    {% set drugs = consumables | selectattr('category','equalto','drug') | list %}
    <div class="summary">
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ Ù…ØµØ±ÙÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</span><div class="sum-val">{{ supplies|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ù…ØµØ±ÙÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Øª)</span><div class="sum-val">{{ supplies|sum(attribute='total_cost')|int | fa_num }}</div></div>
      <div class="sum-box"><span>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø±Ùˆ</span><div class="sum-val">{{ drugs|length }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ø¯Ø§Ø±Ùˆ (Øª)</span><div class="sum-val">{{ drugs|sum(attribute='total_cost')|int | fa_num }}</div></div>
      <div class="sum-box"><span>Ø¬Ù…Ø¹ Ú©Ù„ (Øª)</span><div class="sum-val">{{ ((supplies|sum(attribute='total_cost') + drugs|sum(attribute='total_cost'))|int) | fa_num }}</div></div>
    </div>
    <div class="sub-tabs">
      <button class="sub-tab-btn active" data-sub="supply">Ù…ØµØ±ÙÛŒâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</button>
      <button class="sub-tab-btn" data-sub="drug">Ø¯Ø§Ø±ÙˆÙ‡Ø§</button>
    </div>
    <div id="sub-panel-supply" class="sub-panel">
      {% if supplies %}
      <div style="overflow:auto;max-height:60vh;">
        <table>
          <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù†Ø§Ù… Ù‚Ù„Ù…</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th><th>Ø¬Ù…Ø¹ Ú©Ù„</th><th>Ø¢ÙˆØ±Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±ØŸ</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
          <tbody>
          {% for r in supplies %}
            <tr>
              <td>{{ r.usage_date | jalali_datetime }}</td>
              <td style="font-weight:600;">{{ r.patient_name }}</td>
              <td><span class="badge">{{ r.item_name }}</span></td>
              <td>{{ r.quantity }}</td>
              <td>{{ (r.unit_price or 0)|int | fa_num }}</td>
              <td style="font-weight:700;">{{ (r.total_cost or 0)|int | fa_num }}</td>
              <td>{% if r.patient_provided == 1 %}âœ…{% else %}âŒ{% endif %}</td>
              <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}<div class="empty">Ù…ØµØ±ÙÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
    </div>
    <div id="sub-panel-drug" class="sub-panel" style="display:none;">
      {% if drugs %}
      <div style="overflow:auto;max-height:60vh;">
        <table>
          <thead><tr><th>Ø²Ù…Ø§Ù†</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th><th>Ø¬Ù…Ø¹ Ú©Ù„</th><th>Ø¢ÙˆØ±Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±ØŸ</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th></tr></thead>
          <tbody>
          {% for r in drugs %}
            <tr>
              <td>{{ r.usage_date | jalali_datetime }}</td>
              <td style="font-weight:600;">{{ r.patient_name }}</td>
              <td><span class="badge">{{ r.item_name }}</span></td>
              <td>{{ r.quantity }}</td>
              <td>{{ (r.unit_price or 0)|int | fa_num }}</td>
              <td style="font-weight:700;">{{ (r.total_cost or 0)|int | fa_num }}</td>
              <td>{% if r.patient_provided == 1 %}âœ…{% else %}âŒ{% endif %}</td>
              <td style="max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}<div class="empty">Ø¯Ø§Ø±ÙˆÛŒÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ø´ÛŒÙØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>{% endif %}
    </div>
  </div>
 </div>
 <script>
  // Theme toggle (shared localStorage key)
  function applyTheme(){ const t = localStorage.getItem('receptionTheme')||'light'; if(t==='dark'){ document.body.classList.add('theme-dark'); toggle.textContent='â˜€ï¸ ØªÙ… Ø±ÙˆØ²'; } else { document.body.classList.remove('theme-dark'); toggle.textContent='ğŸŒ™ ØªÙ… Ø´Ø¨'; } }
  const toggle = document.getElementById('themeToggleLedgers');
  applyTheme();
  toggle.addEventListener('click',()=>{ const isDark = document.body.classList.toggle('theme-dark'); localStorage.setItem('receptionTheme', isDark?'dark':'light'); applyTheme(); });
  // Main ledger tabs (exclude sub-tabs)
  document.querySelectorAll('.tab-btn[data-tab]').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn[data-tab]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      const id = 'panel-' + b.dataset.tab;
      const panel = document.getElementById(id);
      if(panel) panel.classList.add('active');
    });
  });
  // Sub tab switching (Ù…ØµØ±ÙÛŒâ€ŒÙ‡Ø§ Ùˆ Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ)
  document.querySelectorAll('.sub-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ prefix
      const sub = btn.dataset.sub;
      const isNursing = sub.startsWith('nursing-');

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ù…â€ŒÚ¯Ø±ÙˆÙ‡
      document.querySelectorAll('.sub-tab-btn').forEach(x => {
        const xs = x.dataset.sub;
        if ((isNursing && xs.startsWith('nursing-')) || (!isNursing && !xs.startsWith('nursing-'))) {
          x.classList.remove('active');
        }
      });
      btn.classList.add('active');

      if (isNursing) {
        const allPanel = document.getElementById('sub-panel-nursing-all');
        const docPanel = document.getElementById('sub-panel-nursing-doctor');
        if(allPanel && docPanel){
          allPanel.style.display = sub==='nursing-all' ? 'block' : 'none';
          docPanel.style.display = sub==='nursing-doctor' ? 'block' : 'none';
        }
      } else {
        const supplyPanel = document.getElementById('sub-panel-supply');
        const drugPanel = document.getElementById('sub-panel-drug');
        if(supplyPanel && drugPanel){
          supplyPanel.style.display = sub==='supply' ? 'block' : 'none';
          drugPanel.style.display = sub==='drug' ? 'block' : 'none';
        }
      }
    });
  });

  // Invoice Details Modal
  // ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ Ùˆ Ø¨Ø§ Ø²Ù…Ø§Ù† Ù…Ø­Ù„ÛŒ Ø§ÛŒØ±Ø§Ù† Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯
  // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  function displayDate(dateStr) {
    if(!dateStr || dateStr === 'â€”') return 'â€”';
    return dateStr;
  }

  async function showInvoiceDetails(invoiceId) {
    const modal = document.getElementById('invoice-modal');
    const modalBody = document.getElementById('modal-body-content');
    modalBody.innerHTML = '<div style="text-align:center;padding:2rem;color:#64748b;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
    modal.classList.add('active');
    
    try {
      const resp = await fetch(`/reception/api/invoice/${invoiceId}/details`);
      if(!resp.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
      const data = await resp.json();
      const inv = data.invoice;
      const items = data.items || [];
      const fin = data.financials || {};
      
      const typeLabels = {visit:'ÙˆÛŒØ²ÛŒØª', injection:'Ø®Ø¯Ù…Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ', procedure:'Ú©Ø§Ø± Ø¹Ù…Ù„ÛŒ', consumable:'Ù…ØµØ±ÙÛŒ'};
      const formatNum = n => new Intl.NumberFormat('fa-IR').format(n||0);
      
      let itemsHtml = items.map(it => {
        const patientProvidedHtml = it.type === 'consumable' 
          ? `<span>Ø¢ÙˆØ±Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±:</span> <strong>${it.patient_provided == 1 ? 'âœ… Ø¨Ù„Ù‡' : 'âŒ Ø®ÛŒØ±'}</strong>` 
          : '';
        // For visits, show recorded_price (base tariff) and patient_share (insurance tariff)
        const priceDisplay = it.type === 'visit' 
          ? `<span>ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡:</span> <strong>${formatNum(it.recorded_price)} Øª</strong>
             <span>Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±:</span> <strong>${formatNum(it.patient_share)} Øª</strong>`
          : `<span>Ù…Ø¨Ù„Øº:</span> <strong>${formatNum(it.recorded_price || it.amount)} Øª</strong>
             <span>Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±:</span> <strong>${formatNum(it.patient_share)} Øª</strong>`;
        const coveredBadge = it.covered_by_insurance ? '<span style="background:#10b981;color:#fff;padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:700;margin-right:.5rem;">ØªØ­Øª Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡</span>' : '';
        return `
        <div class="item-card">
          <span class="item-type ${it.type}">${typeLabels[it.type]||it.type}</span>${coveredBadge}
          <div class="item-details">
            <span>ØªÙˆØ¶ÛŒØ­Ø§Øª:</span> <strong>${it.description||'â€”'}</strong>
            ${priceDisplay}
            <span>Ù¾Ø²Ø´Ú©:</span> <strong>${it.doctor_name||'â€”'}</strong>
            <span>Ù¾Ø±Ø³ØªØ§Ø±:</span> <strong>${it.nurse_name||'â€”'}</strong>
            <span>ØªØ§Ø±ÛŒØ®:</span> <strong>${displayDate(it.date)}</strong>
            ${patientProvidedHtml}
          </div>
        </div>
      `}).join('');
      
      modalBody.innerHTML = `
        <div class="detail-row">
          <div class="detail-item"><div class="detail-label">Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</div><div class="detail-value">#${inv.id}</div></div>
          <div class="detail-item"><div class="detail-label">Ø¨ÛŒÙ…Ø§Ø±</div><div class="detail-value">${inv.patient_name||'â€”'}</div></div>
          <div class="detail-item"><div class="detail-label">Ø¨ÛŒÙ…Ù‡ Ø§ØµÙ„ÛŒ</div><div class="detail-value">${inv.insurance_type||'Ø¢Ø²Ø§Ø¯'}</div></div>
          <div class="detail-item"><div class="detail-label">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</div><div class="detail-value">${inv.supplementary_insurance||'â€”'}</div></div>
          <div class="detail-item"><div class="detail-label">Ù¾Ø°ÛŒØ±Ø´</div><div class="detail-value">${inv.opened_by_name||inv.opened_by||'â€”'}</div></div>
          <div class="detail-item"><div class="detail-label">ÙˆØ¶Ø¹ÛŒØª</div><div class="detail-value">${inv.status==='closed'?'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡':'Ø¨Ø§Ø²'}</div></div>
        </div>
        <div class="detail-row">
          <div class="detail-item"><div class="detail-label">Ø²Ù…Ø§Ù† Ø¨Ø§Ø² Ø´Ø¯Ù†</div><div class="detail-value">${displayDate(inv.opened_at)}</div></div>
          <div class="detail-item"><div class="detail-label">Ø²Ù…Ø§Ù† Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†</div><div class="detail-value">${displayDate(inv.closed_at)}</div></div>
        </div>
        <div class="items-section">
          <h3>Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± (${items.length} Ù…ÙˆØ±Ø¯)</h3>
          ${itemsHtml || '<div class="empty">Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'}
        </div>
        <div class="financials-box">
          <h4>Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ</h4>
          <div class="fin-row"><span>ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§:</span><span>${formatNum(fin.visits)} Øª</span></div>
          <div class="fin-row"><span>Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ:</span><span>${formatNum(fin.injections)} Øª</span></div>
          <div class="fin-row"><span>Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ:</span><span>${formatNum(fin.procedures)} Øª</span></div>
          <div class="fin-row" style="color:#f59e0b;"><span>Ù…ØµØ±ÙÛŒâ€ŒÙ‡Ø§ (ØºÛŒØ± Ø¯Ø±Ø¢Ù…Ø¯ÛŒ):</span><span>${formatNum(fin.consumables)} Øª</span></div>
          <div class="fin-row" style="border-top:1px solid rgba(255,255,255,.3);margin-top:.4rem;padding-top:.4rem;"><span>ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯ (Ø¨Ø¯ÙˆÙ† Ù…ØµØ±ÙÛŒ):</span><span>${formatNum(fin.revenue)} Øª</span></div>
          <div class="fin-row total"><span>Ø¬Ù…Ø¹ Ú©Ù„ ÙØ§Ú©ØªÙˆØ±:</span><span>${formatNum(fin.total)} Øª</span></div>
          <div class="fin-row" style="color:#4ade80;"><span>ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†:</span><span>${formatNum(fin.paid_card)} Øª</span></div>
          <div class="fin-row" style="color:#cbd5e1;"><span>ğŸ’µ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ:</span><span>${formatNum(fin.paid_cash)} Øª</span></div>
          <div class="fin-row" style="color:#fbbf24;"><span>Ù…Ø§Ù†Ø¯Ù‡:</span><span>${formatNum(fin.remaining)} Øª</span></div>
        </div>
      `;
    } catch(e) {
      modalBody.innerHTML = `<div class="empty" style="color:#ef4444;">${e.message}</div>`;
    }
  }
  
  function closeModal() {
    document.getElementById('invoice-modal').classList.remove('active');
  }
  
  // Close modal on overlay click
  document.getElementById('invoice-modal')?.addEventListener('click', e => {
    if(e.target.classList.contains('modal-overlay')) closeModal();
  });
 </script>

 <!-- Invoice Details Modal -->
 <div id="invoice-modal" class="modal-overlay">
   <div class="modal">
     <div class="modal-header">
       <h2>Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ§Ú©ØªÙˆØ±</h2>
       <button class="modal-close" onclick="closeModal()">Ã—</button>
     </div>
     <div class="modal-body" id="modal-body-content"></div>
   </div>
 </div>
</body>
</html>
