<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø«Ø¨Øª Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ùˆ Ù…ØµØ±ÙÛŒ</title>
  <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ± -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
  
  <style>
    /* ØªÙ… Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ Ùˆ Ù…Ø¯Ø±Ù† */
    :root {
      --sidebar-bg: #111827;
      --sidebar-text: #e5e7eb;
      --main-bg: #f3f4f6;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --card-bg: #ffffff;
      --text-dark: #111827;
      --border-color: #d1d5db;
      --table-header-bg: #f9fafb;
      --table-row-hover: #eef2ff;
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
      --sidebar-width: 260px;
    }
    /* Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ Ø³Ø±Ø§Ø³Ø±ÛŒ */
    body.theme-dark {
      --sidebar-bg: #0d1117;
      --sidebar-text: #cbd5e1;
      --main-bg: #030712;
      --accent: #818cf8;
      --accent-hover: #6366f1;
      --card-bg: #1f2937;
      --text-dark: #f9fafb;
      --border-color: #374151;
      --table-header-bg: #111827;
      --table-row-hover: #1e1b4b;
      --primary: #818cf8;
      --primary-hover: #6366f1;
      --text-main: #f9fafb;
      --text-muted: #94a3b8;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,var(--main-bg) 0%, #1e3a8a22 100%); color:var(--text-main); height:100vh; overflow:hidden; }

    /* --- Layout Structure --- */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* --- Sidebar --- */
    .sidebar { width:var(--sidebar-width); background-color:var(--sidebar-bg); color:var(--sidebar-text); display:flex; flex-direction:column; padding:20px 18px; flex-shrink:0; box-shadow:-4px 0 12px rgba(0,0,0,0.25); }

    .brand {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 5px;
      display: block;
    }

    .sidebar-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #d1d5db;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .nav-btn.active { background:linear-gradient(90deg,#6366f1,#8b5cf6); color:#fff; box-shadow:0 4px 12px rgba(99,102,241,0.4); }
    body.theme-dark .nav-btn { background:rgba(255,255,255,0.08); color:#cbd5e1; }
    body.theme-dark .nav-btn:hover { background:rgba(255,255,255,0.15); color:#fff; }

    .back-btn {
      margin-top: auto;
      background: rgba(255,255,255,0.1);
      color: #fff;
      text-align: center;
      justify-content: center;
    }

    /* --- Main Content --- */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .content-card { background:var(--card-bg); border-radius:20px; box-shadow:0 10px 25px -6px rgba(0,0,0,0.35); border:1px solid var(--border-color); overflow:hidden; display:flex; flex-direction:column; min-height:600px; backdrop-filter:blur(8px); }

    /* --- Tabs Header --- */
    .tabs-header { display:flex; padding:0 20px; border-bottom:1px solid var(--border-color); background:var(--table-header-bg); }

    .tab-btn {
      padding: 16px 24px;
      font-family: inherit;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .tab-btn { padding:16px 24px; font-family:inherit; font-weight:700; color:var(--text-muted); background:transparent; border:none; cursor:pointer; border-bottom:3px solid transparent; transition:.2s; font-size:.95rem; }
    .tab-btn:hover { background:var(--table-row-hover); }
    .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); background:var(--card-bg); }
    body.theme-dark .tab-btn { color:#94a3b8; }
    body.theme-dark .tab-btn.active { color:var(--primary); }
    
      .tab-panel {
        display: none !important;
        padding: 24px;
        animation: fadeIn 0.3s ease;
      }
      .tab-panel.active { display: block !important; }
    .form-grid { display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:16px; align-items:end; margin-bottom:24px; background:var(--table-header-bg); padding:20px; border-radius:14px; border:1px solid var(--border-color); }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
    
    input[type="text"], input[type="number"], select, textarea { padding:10px 12px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-main); border-radius:10px; font-family:inherit; font-size:.9rem; transition:border .2s, box-shadow .2s; width:100%; }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,0.35); }
    body.theme-dark input[type="text"], body.theme-dark input[type="number"], body.theme-dark select, body.theme-dark textarea { background:#1e293b; }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    /* --- Tables --- */
    .table-wrapper {
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { background:var(--table-header-bg); padding:12px 16px; text-align:right; font-weight:700; color:var(--text-muted); border-bottom:1px solid var(--border-color); }
    body.theme-dark th { color:#94a3b8; }
    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background:var(--table-row-hover); }

    .action-btn {
      background: #fee2e2;
      color: var(--danger);
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .action-btn:hover { background: var(--danger); color: #fff; }

    /* --- List Items (Consumables) --- */
    .search-box { margin-bottom: 16px; position: relative; }
    .search-box input { padding-right: 36px; } /* Space for icon if added */
    
    .item-list-container { max-height:350px; overflow-y:auto; border:1px solid var(--border-color); border-radius:10px; background:var(--card-bg); }
    
    .list-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    .list-row:hover { background:var(--table-row-hover); }
    .list-row:last-child { border-bottom: none; }

    .item-name { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }
    .chip-price { background:rgba(99,102,241,0.12); color:var(--primary); font-size:.8rem; font-weight:700; padding:5px 12px; border-radius:8px; min-width:80px; text-align:center; }
    body.theme-dark .chip-price { background:rgba(99,102,241,0.25); }

    /* performer badge (light in light theme, subtle in dark theme) */
    .performer-badge {
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
      background: #f3f4f6;
      color: var(--text-dark);
      font-weight: 600;
    }
    body.theme-dark .performer-badge {
      background: rgba(255,255,255,0.04);
      color: var(--text-main);
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* --- Footer Summary --- */
    .footer-section { margin-top:auto; padding:20px; background:var(--table-header-bg); border-top:1px solid var(--border-color); display:flex; flex-direction:column; gap:16px; }

    .notes-area { width: 100%; min-height: 80px; resize: vertical; }

    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-display {
      display: flex;
      flex-direction: column;
    }
    .total-label { font-size: 0.8rem; color: var(--text-muted); }
    .total-amount { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
    .total-amount span { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); }

    .buttons-row { display: flex; gap: 12px; }
    .btn-secondary { background:transparent; border:2px solid var(--border-color); color:var(--text-main); padding:10px 20px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn-secondary:hover { background:var(--table-row-hover); }
    body.theme-dark .btn-secondary { color:#94a3b8; }
    body.theme-dark .btn-secondary:hover { color:var(--text-main); }

    /* Responsive Helpers */
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr 1fr; }
      .form-grid button { grid-column: span 2; }
    }
  </style>
</head>
<body>

<div class="app-container">
  
  <!-- Sidebar (Right Side) - replaced with nursing services sidebar -->
  <aside class="sidebar">
      <div class="app-brand">ğŸ¥ Ø¯Ø±Ù…Ø§Ù†Ú¯Ø§Ù‡ Ø³ÛŒØ¨</div>
      
      <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px; border:1px solid rgba(255,255,255,0.1);">
          <div style="color:#9ca3af; font-size:0.85rem; margin-bottom:0.5rem;">Ø¨ÛŒÙ…Ø§Ø± ÙØ¹Ø§Ù„:</div>
          <div style="font-weight:800; color:white; font-size:1.1rem; margin-bottom:0.2rem;">{% if invoice %}{{ invoice.patient_name }}{% else %}---{% endif %}</div>
          <div style="color:#6366f1; font-size:0.8rem;">{{ g.user['username'] }}</div>
      </div>

      <!-- Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª -->
      <a href="#" class="nav-btn active">ğŸ’‰ Ø«Ø¨Øª Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</a>
      {% if invoice %}
      <a href="{{ url_for('reception.index', invoice_id=invoice.id) }}" class="nav-btn">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±</a>
      {% endif %}
  </aside>

  <!-- Main Content (Left Side) -->
  <main class="main-content">
    
    {% if not invoice %}
      <div class="content-card" style="align-items:center; justify-content:center; padding:40px;">
        <h3>Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h3>
        <a href="{{ url_for('reception.index') }}" class="btn-primary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</a>
      </div>
    {% else %}

    <!-- Hidden Data for JS -->
    <div id="data-root" 
         data-invoice-id="{{ invoice.id }}" 
         data-consumables='{{ supplies|tojson|safe }}' 
         data-drugs='{{ drugs|tojson|safe }}' 
         data-index-url='{{ url_for("reception.index") }}' 
         data-submit-url='{{ url_for("reception.procedures_submit") }}'>
    </div>

    <!-- Insurance coverage note -->
    <div style="margin:0.75rem 1.25rem; padding:0.8rem 1rem; border-radius:10px; background:#f1f5f9; border:1px solid var(--border-color); color:var(--text-muted);">
      ØªÙˆØ¬Ù‡: Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø¨ÛŒÙ…Ù‡â€ŒÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ø±Ø§ Ù¾ÙˆØ´Ø´ Ø¯Ù‡Ø¯ØŒ Ø³Ù‡Ù… Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØµÙØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
    </div>

    <!-- Main Card -->
    <div class="content-card">
      <!-- Tabs Header -->
      <div class="tabs-header">
        <button type="button" class="tab-btn active" data-tab="procedures">âœ¨ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ</button>
        <button type="button" class="tab-btn" data-tab="consumables">ğŸ“¦ Ù…ØµØ±ÙÛŒâ€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø±Ùˆ</button>
      </div>

      <!-- Procedure Tab -->
      <div class="tab-panel active" id="panel-procedures">
        <!-- Input Form -->
        <div class="form-grid">
          <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø± Ø¹Ù…Ù„ÛŒ</label>
            <input type="text" id="procName" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø®ÛŒÙ‡ ÛŒØ§ Ù¾Ø§Ù†Ø³Ù…Ø§Ù†...">
          </div>
          <div class="form-group">
            <label>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="number" id="procPrice" placeholder="0">
          </div>
          <div class="form-group">
            <label>ØªØ¹Ø¯Ø§Ø¯</label>
            <input type="number" id="procQty" value="1" min="1">
          </div>
          <button type="button" id="addProcBtn" class="btn-primary">
            <span>+</span> Ø§ÙØ²ÙˆØ¯Ù†
          </button>
        </div>

        <div class="form-group" style="margin-bottom: 12px; flex-direction: row; align-items: center; gap: 10px;">
          <label>Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ù†Ø¯Ù‡:</label>
          <select id="procPerformer" style="width: 150px;">
            <option value="doctor">Ù¾Ø²Ø´Ú©</option>
            <option value="nurse">Ù¾Ø±Ø³ØªØ§Ø±</option>
          </select>
        </div>

        <!-- Procedures Table -->
        <div class="table-wrapper">
          <table id="procTable">
            <thead>
              <tr>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø®Ø¯Ù…Øª</th>
                <th style="width:80px; text-align:center;">ØªØ¹Ø¯Ø§Ø¯</th>
                <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                <th>Ø¬Ù…Ø¹ Ú©Ù„</th>
                <th>Ù¾Ø±Ø³Ù†Ù„</th>
                <th style="width:50px;"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows inserted by JS -->
            </tbody>
          </table>
        </div>
        <div style="margin-top:10px; text-align:left; font-weight:bold; color:var(--primary);">
          Ø¬Ù…Ø¹ Ø¹Ù…Ù„ÛŒ: <span id="procTotalDisplay">0</span>
        </div>
      </div>

      <!-- Consumables Tab -->
      <div class="tab-panel" id="panel-consumables">
        <div class="search-box">
          <input type="text" id="consSearch" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ ÛŒØ§ Ù„ÙˆØ§Ø²Ù… Ù…ØµØ±ÙÛŒ...">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 400px;">
          <!-- List Items -->
          <div class="item-list-container" id="consList">
            <!-- Items inserted by JS -->
          </div>

          <!-- Selected Table -->
          <div class="table-wrapper" style="overflow-y:auto;">
            <table id="consTable">
              <thead>
                <tr>
                  <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                  <th style="width:70px;">ØªØ¹Ø¯Ø§Ø¯</th>
                  <th>Ù‚ÛŒÙ…Øª</th>
                  <th>Ø¬Ù…Ø¹</th>
                  <th style="font-size:0.8rem">Ø¢ÙˆØ±Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div style="margin-top:10px; text-align:left; font-weight:bold; color:var(--primary);">
          Ø¬Ù…Ø¹ Ù…ØµØ±ÙÛŒ: <span id="consTotalDisplay">0</span>
        </div>
      </div>

      <!-- Footer Section -->
      <div class="footer-section">
        <div>
          <label style="display:block; margin-bottom:8px;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÛŒØ§ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ:</label>
          <textarea id="notes" class="notes-area" placeholder="Ø§Ú¯Ø± ØªÙˆØ¶ÛŒØ­ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ ÛŒØ§ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        </div>
        
        <div class="action-bar">
          <div class="total-display">
            <span class="total-label">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
            <span class="total-amount" id="grandTotalDisplay">0 <span>ØªÙˆÙ…Ø§Ù†</span></span>
          </div>
          <div class="buttons-row">
            <button class="btn-secondary" data-action="cancel">Ù„ØºÙˆ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <button class="btn-primary" id="submitAll" style="min-width: 160px;">
              Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡
            </button>
          </div>
        </div>
      </div>

    </div>
    {% endif %}
  </main>
</div>

<!-- JavaScript Logic -->
<script>
  const dataRootEl = document.getElementById('data-root');
  
  // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¨ÙˆØ¯ (Ø­Ø§Ù„Øª Ø¨Ø¯ÙˆÙ† ÙØ§Ú©ØªÙˆØ±) Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¬Ø±Ø§ Ù†Ø´ÙˆØ¯
  if (!dataRootEl) {
    console.log('No invoice data');
  } else {
    const DATA_ROOT = {
      consumables: JSON.parse(dataRootEl.dataset.consumables || '[]'),
      drugs: JSON.parse(dataRootEl.dataset.drugs || '[]'),
      invoiceId: dataRootEl.dataset.invoiceId ? parseInt(dataRootEl.dataset.invoiceId) : null,
      indexUrl: dataRootEl.dataset.indexUrl || '',
      submitUrl: dataRootEl.dataset.submitUrl || ''
    };

    // --- Tab Switching Logic ---
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove active form all
        tabBtns.forEach(b => b.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));
        
        // Add active to current
        btn.classList.add('active');
        const targetId = 'panel-' + btn.dataset.tab;
        document.getElementById(targetId).classList.add('active');
      });
    });

    // --- Procedure Logic ---
    const procTbody = document.querySelector('#procTable tbody');
    
    function addManualProcedure() {
      const nameInp = document.getElementById('procName');
      const priceInp = document.getElementById('procPrice');
      const qtyInp = document.getElementById('procQty');
      const performerInp = document.getElementById('procPerformer');

      const name = nameInp.value.trim();
      const price = parseFloat(priceInp.value || 0);
      let qty = parseInt(qtyInp.value || '1');

      if(!name) { alert('Ù„Ø·ÙØ§ Ø¹Ù†ÙˆØ§Ù† Ø®Ø¯Ù…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      if(qty < 1) qty = 1;

      const performerVal = performerInp.value;
      const performerText = performerInp.options[performerInp.selectedIndex].text;

      const tr = document.createElement('tr');
      tr.dataset.name = name;
      tr.dataset.price = price;
      tr.dataset.performer = performerVal;

      tr.innerHTML = `
        <td>${name}</td>
        <td style="text-align:center;">
          <input type="number" class="qty-input" value="${qty}" min="1" style="width:60px; padding:4px; text-align:center;">
        </td>
        <td>${price.toLocaleString()}</td>
        <td class="line-total" style="font-weight:bold;">${(price * qty).toLocaleString()}</td>
        <td><span class="performer-badge">${performerText}</span></td>
        <td><button class="action-btn">Ã—</button></td>
      `;

      procTbody.appendChild(tr);
      
      // Reset inputs
      nameInp.value = '';
      priceInp.value = '';
      qtyInp.value = '1';
      nameInp.focus();

      recalcAll();
    }

    document.getElementById('addProcBtn').addEventListener('click', addManualProcedure);

    // Event Delegation for Procedures
    procTbody.addEventListener('click', e => {
      if(e.target.closest('.action-btn')) {
        e.target.closest('tr').remove();
        recalcAll();
      }
    });

    procTbody.addEventListener('input', e => {
      if(e.target.classList.contains('qty-input')) {
        const tr = e.target.closest('tr');
        let qty = parseInt(e.target.value);
        if(qty < 1) { qty = 1; e.target.value = 1; }
        
        const unitPrice = parseFloat(tr.dataset.price);
        tr.querySelector('.line-total').textContent = (qty * unitPrice).toLocaleString();
        recalcAll();
      }
    });


    // --- Consumables Logic ---
    const consList = document.getElementById('consList');
    const consTbody = document.querySelector('#consTable tbody');
    const consSearch = document.getElementById('consSearch');

    function buildConsumableList() {
      const allItems = [
        ...DATA_ROOT.consumables.map(c => ({...c, category: 'supply'})),
        ...DATA_ROOT.drugs.map(d => ({...d, category: 'drug'}))
      ];
      
      const query = consSearch.value.trim();
      consList.innerHTML = '';

      const filtered = allItems.filter(it => it.name.includes(query));

      filtered.forEach(item => {
        const row = document.createElement('div');
        row.className = 'list-row';
        
        const isDrug = item.category === 'drug';
        const icon = isDrug ? 'ğŸ’Š' : 'ğŸ©¹';

        row.innerHTML = `
          <span class="item-name">${item.name} <small>${icon}</small></span>
          <span class="chip-price">${item.default_price.toLocaleString()}</span>
        `;
        
        row.addEventListener('click', () => addConsumableToTable(item));
        consList.appendChild(row);
      });
    }

    consSearch.addEventListener('input', buildConsumableList);
    buildConsumableList(); // Init list

    function addConsumableToTable(item) {
      // Check if exists
      const existingRow = [...consTbody.querySelectorAll('tr')].find(r => r.dataset.name === item.name);
      if(existingRow) {
        const inp = existingRow.querySelector('.qty-input');
        inp.value = parseInt(inp.value) + 1;
        updateConsRow(existingRow);
        return;
      }

      const tr = document.createElement('tr');
      tr.dataset.name = item.name;
      tr.dataset.price = item.default_price;
      tr.dataset.category = item.category;

      tr.innerHTML = `
        <td>${item.name}</td>
        <td><input type="number" class="qty-input" value="1" min="1" style="width:50px; padding:4px; text-align:center;"></td>
        <td>${item.default_price.toLocaleString()}</td>
        <td class="line-total" style="font-weight:bold;">${item.default_price.toLocaleString()}</td>
        <td style="text-align:center;"><input type="checkbox" class="patient-provided" style="width:26px; height:26px; cursor:pointer; accent-color:#10b981;"></td>
        <td><button class="action-btn">Ã—</button></td>
      `;
      consTbody.appendChild(tr);
      recalcAll();
    }

    function updateConsRow(tr) {
      const qty = parseInt(tr.querySelector('.qty-input').value);
      const price = parseFloat(tr.dataset.price);
      const isProvided = tr.querySelector('.patient-provided').checked;
      
      const total = isProvided ? 0 : (qty * price);
      tr.querySelector('.line-total').textContent = total.toLocaleString();
      recalcAll();
    }

    // Event Delegation for Consumables
    consTbody.addEventListener('click', e => {
      if(e.target.closest('.action-btn')) {
        e.target.closest('tr').remove();
        recalcAll();
      }
    });
    consTbody.addEventListener('input', e => {
      if(e.target.classList.contains('qty-input')) {
        let qty = parseInt(e.target.value);
        if(qty < 1) { e.target.value = 1; }
        updateConsRow(e.target.closest('tr'));
      }
    });
    consTbody.addEventListener('change', e => {
      if(e.target.classList.contains('patient-provided')) {
        updateConsRow(e.target.closest('tr'));
      }
    });


    // --- Calculations ---
    function recalcAll() {
      let procSum = 0;
      procTbody.querySelectorAll('tr').forEach(tr => {
         const q = parseInt(tr.querySelector('.qty-input').value);
         const p = parseFloat(tr.dataset.price);
         procSum += q * p;
      });

      let consSum = 0;
      consTbody.querySelectorAll('tr').forEach(tr => {
         const q = parseInt(tr.querySelector('.qty-input').value);
         const p = parseFloat(tr.dataset.price);
         const isFree = tr.querySelector('.patient-provided').checked;
         if(!isFree) consSum += q * p;
      });

      document.getElementById('procTotalDisplay').textContent = procSum.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
      document.getElementById('consTotalDisplay').textContent = consSum.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
      
      const grand = procSum + consSum;
      document.getElementById('grandTotalDisplay').innerHTML = grand.toLocaleString() + ' <span>ØªÙˆÙ…Ø§Ù†</span>';
    }


    // --- Submit ---
    document.getElementById('submitAll').addEventListener('click', () => {
      const procedures = [];
      procTbody.querySelectorAll('tr').forEach(tr => {
        procedures.push({
          name: tr.dataset.name,
          unit_price: parseFloat(tr.dataset.price),
          qty: parseInt(tr.querySelector('.qty-input').value),
          performer_type: tr.dataset.performer
        });
      });

      const consumables = [];
      consTbody.querySelectorAll('tr').forEach(tr => {
        consumables.push({
          name: tr.dataset.name,
          unit_price: parseFloat(tr.dataset.price),
          qty: parseInt(tr.querySelector('.qty-input').value),
          patient_provided: tr.querySelector('.patient-provided').checked,
          category: tr.dataset.category
        });
      });

      if(procedures.length === 0 && consumables.length === 0) {
        alert('Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª! Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
        return;
      }

      const payload = {
        invoice_id: DATA_ROOT.invoiceId,
        procedures: procedures,
        consumables: consumables,
        notes: document.getElementById('notes').value
      };

      // Simulate Fetch for UI Demo (Replace with actual Fetch)
      fetch(DATA_ROOT.submitUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          // alert('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
          window.location.href = DATA_ROOT.indexUrl + '?invoice_id=' + DATA_ROOT.invoiceId;
        } else {
          alert('Ø®Ø·Ø§: ' + (data.error || 'Unknown Error'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
      });
    });

    // Cancel Button
    document.querySelector('[data-action="cancel"]').addEventListener('click', () => {
      window.location.href = DATA_ROOT.indexUrl + (DATA_ROOT.invoiceId ? '?invoice_id='+DATA_ROOT.invoiceId : '');
    });
  }
</script>
<script>
 // Ø§Ø¹Ù…Ø§Ù„ ØªÙ… Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ localStorage
 (function(){ const t = localStorage.getItem('receptionTheme')||'light'; if(t==='dark') document.body.classList.add('theme-dark'); })();
</script>

</body>
</html>