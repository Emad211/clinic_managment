<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ÙˆÛŒØ²ÛŒØª Ø¬Ø¯ÛŒØ¯ - Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ù…Ø§Ù†Ú¯Ø§Ù‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* ØªÙ… Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ Ùˆ Ù…Ø¯Ø±Ù† */
        :root { --bg-grad-start:#6366f1; --bg-grad-end:#818cf8; --card-bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#d1d5db; --accent:#6366f1; }
        body.theme-dark { --bg-grad-start:#0d1117; --bg-grad-end:#030712; --card-bg:#1f2937; --text:#f9fafb; --muted:#94a3b8; --border:#374151; --accent:#818cf8; }
        body { font-family: Tahoma, 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); min-height: 100vh; padding: 2rem 1rem; color: var(--text); transition:.3s; }
        
        .container { max-width: 700px; margin: 0 auto; }
        
        /* Form Card */
        .form-card { background: var(--card-bg); border-radius: 16px; padding: 2rem; box-shadow: 0 8px 28px -4px rgba(0,0,0,0.35); border:1px solid var(--border); transition:.3s; }
        .form-header { text-align: center; margin-bottom: 2rem; }
        .form-title { font-size: 1.7rem; font-weight: 800; color: var(--text); margin-bottom: 0.5rem; }
        .form-subtitle { color: var(--muted); font-size: 1rem; }
        
        /* Form Fields */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.95rem; }
        .form-label .required { color: #ef4444; margin-right: 2px; }
        .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: var(--card-bg); color: var(--text); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.25); }
        .form-input::placeholder { color: #9ca3af; }
        .form-input.error, .form-select.error { border-color: #ef4444; }
        .form-hint { font-size: 0.85rem; color: #6b7280; margin-top: 0.3rem; display: block; }
        .form-hint.error { color: #ef4444; }
        .form-hint.success { color: #059669; font-weight: 600; }
        
        /* Checkbox */
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .checkbox-input { width: 20px; height: 20px; cursor: pointer; accent-color: #667eea; }
        .checkbox-label { font-weight: 600; color: var(--text); cursor: pointer; user-select: none; }
        
        /* Price Display */
        .price-card { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; text-align: center; }
        .price-label { font-size: 0.9rem; color: #166534; font-weight: 600; margin-bottom: 0.3rem; }
        .price-value { font-size: 1.5rem; font-weight: 700; color: #15803d; }
        
        /* Buttons */
        .form-actions { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn { flex: 1; padding: 0.9rem 1.5rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        
        /* Alert Messages */
        .alert { padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; font-weight: 500; display: none; }
        .alert.show { display: block; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #6ee7b7; }
        
        /* Divider */
        .divider { height: 1px; background: linear-gradient(90deg, transparent, #e5e7eb, transparent); margin: 1.5rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <div style="display:flex;justify-content:flex-end;margin-bottom:.5rem;">
                <button id="themeToggleVisit" style="background:#eef2ff;color:#1e293b;border:1px solid var(--border);padding:.45rem .9rem;border-radius:8px;font-weight:700;font-size:.7rem;cursor:pointer;">ğŸŒ™ ØªÙ… Ø´Ø¨</button>
            </div>
            <div class="form-header">
                <div class="form-title">ğŸ“‹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</div>
                <div class="form-subtitle">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± Ùˆ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
            </div>

            <!-- Alert Messages -->
            <div class="alert alert-error" id="error-alert"></div>
            <div class="alert alert-success" id="success-alert"></div>

            <form id="visit-form" method="POST">
                <!-- Patient Name -->
                <div class="form-group">
                    <label class="form-label" for="name">
                        <span class="required">*</span>
                        Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±:
                    </label>
                    <input type="text" class="form-input" id="name" name="name" placeholder="Ù†Ø§Ù…" required>
                </div>

                <!-- Family Name -->
                <div class="form-group">
                    <label class="form-label" for="family_name">
                        <span class="required">*</span>
                        Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:
                    </label>
                    <input type="text" class="form-input" id="family_name" name="family_name" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
                </div>

                <!-- Phone Number -->
                <div class="form-group">
                    <label class="form-label" for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</label>
                    <input type="text" class="form-input" id="phone" name="phone" placeholder="09123456789" maxlength="11" pattern="09[0-9]{9}">
                    <span class="form-hint">Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ùˆ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯</span>
                </div>

                <!-- Foreign National Checkbox -->
                <div class="checkbox-group">
                    <input type="checkbox" class="checkbox-input" id="is_foreign" name="is_foreign">
                    <label class="checkbox-label" for="is_foreign">Ø¨ÛŒÙ…Ø§Ø± Ø®Ø§Ø±Ø¬ÛŒ (Ø¨Ø¯ÙˆÙ† Ú©Ø¯Ù…Ù„ÛŒ)</label>
                </div>

                <!-- National ID with Live Search -->
                <div class="form-group" id="national-id-group">
                    <label class="form-label" for="national_id">
                        <span class="required">*</span>
                        Ú©Ø¯Ù…Ù„ÛŒ:
                    </label>
                    <div style="position:relative;">
                        <input type="text" class="form-input" id="national_id" name="national_id" placeholder="1234567890" maxlength="10" pattern="[0-9]{10}" autocomplete="off">
                        <span id="national-id-search-indicator" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1.2rem;display:none;">â³</span>
                    </div>
                    <span class="form-hint" id="national-id-hint">Ú©Ø¯Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯ â€” Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯Ù…Ù„ÛŒØŒ Ø¨ÛŒÙ…Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</span>
                    <!-- Patient Found Card -->
                    <div id="patient-found-card" style="display:none; margin-top:0.75rem; padding:0.9rem 1rem; background:linear-gradient(135deg,#dcfce7,#bbf7d0); border:2px solid #86efac; border-radius:10px;">
                        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
                            <span style="font-size:1.3rem;">âœ…</span>
                            <strong style="color:#166534;font-size:1rem;">Ø¨ÛŒÙ…Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯!</strong>
                        </div>
                        <div id="patient-found-name" style="color:#15803d;font-weight:700;font-size:1.05rem;"></div>
                        <div id="patient-found-details" style="color:#166534;font-size:0.85rem;margin-top:0.3rem;"></div>
                        <input type="hidden" id="existing_patient_id" name="existing_patient_id" value="">
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Insurance Type -->
                <div class="form-group">
                    <label class="form-label" for="insurance_type">
                        <span class="required">*</span>
                        Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡:
                    </label>
                    <select class="form-select" id="insurance_type" name="insurance_type" required>
                        <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡ â€”</option>
                        {% for tariff in tariffs %}
                        <option value="{{ tariff.insurance_type }}" data-price="{{ tariff.tariff_price }}">{{ tariff.insurance_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Supplementary Insurance -->
                <div class="form-group">
                    <label class="form-label" for="supplementary_insurance">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ:</label>
                    <select class="form-select" id="supplementary_insurance" name="supplementary_insurance">
                        <option value="">Ù†Ø¯Ø§Ø±Ø¯</option>
                        {% if supplementary_insurances %}
                            {% for s in supplementary_insurances %}
                                <option value="{{ s.insurance_type }}" data-price="{{ s.tariff_price }}" data-nursing="{{ s.nursing_tariff }}">{{ s.insurance_type }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Price Display -->
                <div class="price-card" id="price-display" style="display: none;">
                    <div class="price-label">ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª</div>
                    <div class="price-value" id="price-value">0 ØªÙˆÙ…Ø§Ù†</div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        âœ… Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <a href="{{ url_for('reception.index') }}" class="btn btn-secondary">
                        âŒ Ø§Ù†ØµØ±Ø§Ù
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Theme toggle (shared with reception pages)
        const themeBtn = document.getElementById('themeToggleVisit');
        function applyVisitTheme(){ const t = localStorage.getItem('receptionTheme')||'light'; if(t==='dark'){ document.body.classList.add('theme-dark'); themeBtn.textContent='â˜€ï¸ ØªÙ… Ø±ÙˆØ²'; } else { document.body.classList.remove('theme-dark'); themeBtn.textContent='ğŸŒ™ ØªÙ… Ø´Ø¨'; } }
        applyVisitTheme();
        themeBtn.addEventListener('click',()=>{ const isDark=document.body.classList.toggle('theme-dark'); localStorage.setItem('receptionTheme', isDark?'dark':'light'); applyVisitTheme(); });
        // Iranian National ID Validation
        function validateNationalId(nationalId) {
            if (!nationalId || nationalId.length !== 10) return false;
            if (!/^\d+$/.test(nationalId)) return false;
            
            // Check for repeated digits (like 0000000000 or 1111111111)
            if (new Set(nationalId).size === 1) return false;
            
            // Calculate check digit
            const check = parseInt(nationalId[9]);
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(nationalId[i]) * (10 - i);
            }
            const remainder = sum % 11;
            
            if (remainder < 2) {
                return check === remainder;
            } else {
                return check === 11 - remainder;
            }
        }

        // Toggle national ID field based on foreign checkbox
        const isForeignCheckbox = document.getElementById('is_foreign');
        const nationalIdGroup = document.getElementById('national-id-group');
        const nationalIdInput = document.getElementById('national_id');
        const patientFoundCard = document.getElementById('patient-found-card');
        const patientFoundName = document.getElementById('patient-found-name');
        const patientFoundDetails = document.getElementById('patient-found-details');
        const existingPatientIdInput = document.getElementById('existing_patient_id');
        const searchIndicator = document.getElementById('national-id-search-indicator');
        const nationalIdHint = document.getElementById('national-id-hint');
        let searchTimeout = null;
        let lastSearchedId = '';

        isForeignCheckbox.addEventListener('change', function() {
            if (this.checked) {
                nationalIdGroup.style.display = 'none';
                nationalIdInput.removeAttribute('required');
                nationalIdInput.value = '';
                hidePatientFound();
            } else {
                nationalIdGroup.style.display = 'block';
                nationalIdInput.setAttribute('required', 'required');
            }
        });

        function hidePatientFound() {
            patientFoundCard.style.display = 'none';
            existingPatientIdInput.value = '';
        }

        function showPatientFound(patient) {
            patientFoundName.textContent = `${patient.name} ${patient.family_name}`;
            let details = [];
            if (patient.phone_number) details.push(`ğŸ“ ${patient.phone_number}`);
            if (patient.insurance_type) details.push(`ğŸ¥ Ø¨ÛŒÙ…Ù‡: ${patient.insurance_type}`);
            patientFoundDetails.textContent = details.join(' â€” ');
            patientFoundCard.style.display = 'block';
            existingPatientIdInput.value = patient.id || '';

            // Auto-fill form fields
            document.getElementById('name').value = patient.name || '';
            document.getElementById('family_name').value = patient.family_name || '';
            document.getElementById('phone').value = patient.phone_number || '';
            if (patient.insurance_type) {
                const sel = document.getElementById('insurance_type');
                for (let i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value === patient.insurance_type) {
                        sel.selectedIndex = i;
                        updatePrice();
                        break;
                    }
                }
            }
        }

        // Live search when national_id changes
        nationalIdInput.addEventListener('input', function() {
            const val = this.value.trim();
            hidePatientFound();

            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);

            // Only search if 10 digits and valid format
            if (val.length === 10 && /^\d{10}$/.test(val) && val !== lastSearchedId) {
                searchIndicator.style.display = 'inline';
                searchTimeout = setTimeout(async () => {
                    lastSearchedId = val;
                    try {
                        const resp = await fetch(`{{ url_for('reception.search_patient') }}?national_id=${encodeURIComponent(val)}`, {credentials:'same-origin'});
                        const data = await resp.json();
                        searchIndicator.style.display = 'none';
                        if (data.found && data.patient) {
                            showPatientFound(data.patient);
                            nationalIdHint.textContent = 'âœ… Ø¨ÛŒÙ…Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ â€” Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø± Ø´Ø¯';
                            nationalIdHint.classList.add('success');
                            nationalIdHint.classList.remove('error');
                        } else {
                            nationalIdHint.textContent = 'Ø¨ÛŒÙ…Ø§Ø± Ø¬Ø¯ÛŒØ¯ â€” Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯';
                            nationalIdHint.classList.remove('success','error');
                        }
                    } catch (err) {
                        searchIndicator.style.display = 'none';
                        console.error(err);
                    }
                }, 400);
            } else {
                searchIndicator.style.display = 'none';
                if (val.length < 10) {
                    nationalIdHint.textContent = 'Ú©Ø¯Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯';
                    nationalIdHint.classList.remove('success','error');
                }
            }
        });

        // Update price display based on insurance selection
        const insuranceSelect = document.getElementById('insurance_type');
        const suppInsuranceSelect = document.getElementById('supplementary_insurance');
        const priceDisplay = document.getElementById('price-display');
        const priceValue = document.getElementById('price-value');

        // Disable supplementary insurance if base insurance is 'Ø¢Ø²Ø§Ø¯' or empty
        function updateSupplementaryAvailability() {
            const baseInsurance = insuranceSelect.value;
            const isBaseInsuranceValid = baseInsurance && baseInsurance !== 'Ø¢Ø²Ø§Ø¯';
            
            suppInsuranceSelect.disabled = !isBaseInsuranceValid;
            if (!isBaseInsuranceValid) {
                suppInsuranceSelect.value = '';  // Reset to 'Ù†Ø¯Ø§Ø±Ø¯'
                suppInsuranceSelect.style.opacity = '0.5';
                suppInsuranceSelect.style.cursor = 'not-allowed';
            } else {
                suppInsuranceSelect.style.opacity = '1';
                suppInsuranceSelect.style.cursor = 'pointer';
            }
        }

        function updatePrice() {
            const selectedOption = insuranceSelect.options[insuranceSelect.selectedIndex];
            const suppInsurance = suppInsuranceSelect.value;
            
            // Also update supplementary availability
            updateSupplementaryAvailability();

            if (selectedOption && selectedOption.value) {
                // If a supplementary insurance is selected and provides a price, prefer it
                let usePrice = parseFloat(selectedOption.dataset.price || 0);
                let label = 'ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª';
                if (suppInsurance) {
                    const suppOpt = suppInsuranceSelect.options[suppInsuranceSelect.selectedIndex];
                    if (suppOpt && suppOpt.dataset && typeof suppOpt.dataset.price !== 'undefined') {
                        const sPrice = parseFloat(suppOpt.dataset.price);
                        if (!isNaN(sPrice)) {
                            usePrice = sPrice;
                            label = 'ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª (Ø¨Ø§ ØªÚ©Ù…ÛŒÙ„ÛŒ)';
                        }
                    }
                }

                priceDisplay.style.display = 'block';
                const formattedPrice = new Intl.NumberFormat('fa-IR').format(usePrice);
                priceValue.textContent = formattedPrice + ' ØªÙˆÙ…Ø§Ù†';
                priceValue.parentElement.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
                priceValue.parentElement.style.borderColor = '#86efac';
                document.querySelector('.price-label').textContent = label;
            } else {
                priceDisplay.style.display = 'none';
            }
        }

        insuranceSelect.addEventListener('change', updatePrice);
        suppInsuranceSelect.addEventListener('change', updatePrice);
        
        // Initialize supplementary availability on page load
        updateSupplementaryAvailability();

        // Form validation and submission
        const form = document.getElementById('visit-form');
        const errorAlert = document.getElementById('error-alert');
        const successAlert = document.getElementById('success-alert');
        const submitBtn = document.getElementById('submit-btn');

        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.classList.add('show');
            successAlert.classList.remove('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.classList.add('show');
            errorAlert.classList.remove('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            errorAlert.classList.remove('show');
            successAlert.classList.remove('show');

            // Get form data
            const formData = new FormData(form);
            const name = formData.get('name').trim();
            const familyName = formData.get('family_name').trim();
            const phone = formData.get('phone').trim();
            const nationalId = formData.get('national_id').trim();
            const isForeign = formData.get('is_foreign') === 'on';
            const insuranceType = formData.get('insurance_type');
            const suppInsurance = formData.get('supplementary_insurance');

            // Validate required fields
            if (!name || !familyName) {
                showError('âŒ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Validate phone number
            if (phone && (phone.length !== 11 || !phone.startsWith('09') || !/^\d+$/.test(phone))) {
                showError('âŒ Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ùˆ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯');
                return;
            }

            // Validate national ID for Iranian patients
            if (!isForeign) {
                if (!nationalId) {
                    showError('âŒ Ú©Ø¯Ù…Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø§ÛŒØ±Ø§Ù†ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª');
                    return;
                }
                if (nationalId.length !== 10 || !/^\d+$/.test(nationalId)) {
                    showError('âŒ Ú©Ø¯Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                    return;
                }
                // Validate Iranian national ID with check digit
                if (!validateNationalId(nationalId)) {
                    showError('âŒ Ú©Ø¯Ù…Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    return;
                }
            }

            // Validate insurance type
            if (!insuranceType) {
                showError('âŒ Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Submit form
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ±...';

            try {
                const response = await fetch('{{ url_for("reception.new_visit") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('âœ… ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø² Ø´Ø¯');
                    setTimeout(() => {
                        window.location.href = '{{ url_for("reception.index") }}';
                    }, 1000);
                } else {
                    showError('âŒ ' + (result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ±'));
                }
            } catch (error) {
                showError('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                console.error(error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ±';
            }
        });
    </script>
</body>
</html>
