<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { 
    font-family: 'Vazirmatn', sans-serif; 
    background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    color: #e5e7eb; 
    padding: 2rem; 
    min-height: 100vh; 
  }
  .tariffs-page { max-width: 1100px; margin: 0 auto; }
  .page-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 2rem; 
    flex-wrap: wrap; 
    gap: 1rem; 
  }
  .page-header h1 { 
    font-size: 1.6rem; 
    font-weight: 900; 
    color: #f1f5f9; 
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .btn-back { 
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(30,41,59,0.8);
    border: 1px solid rgba(59,130,246,0.3);
    color: #93c5fd; 
    padding: 0.7rem 1.2rem; 
    border-radius: 12px; 
    text-decoration: none; 
    font-size: 0.9rem;
    font-weight: 700;
    transition: all 0.2s;
  }
  .btn-back:hover { 
    background: rgba(59,130,246,0.2);
    border-color: #3b82f6;
    color: #f1f5f9;
    transform: translateX(4px);
  }
  .btn-back svg { width: 18px; height: 18px; }

  /* Base Tariff Card - Special Styling */
  .base-card {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
    backdrop-filter: blur(16px);
    border-radius: 18px;
    padding: 1.5rem 1.8rem;
    border: 2px solid rgba(16, 185, 129, 0.4);
    margin-bottom: 1.5rem;
    box-shadow: 0 20px 50px rgba(16, 185, 129, 0.15);
  }
  .base-card-title {
    font-size: 1.2rem;
    font-weight: 900;
    color: #6ee7b7;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .base-card-subtitle {
    font-size: 0.9rem;
    color: #a7f3d0;
    margin-bottom: 1.2rem;
  }
  .base-form {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .base-field {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .base-field label {
    font-size: 0.85rem;
    color: #6ee7b7;
    font-weight: 700;
  }
  .base-field input {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.4);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    color: #f1f5f9;
    font-size: 1.1rem;
    font-weight: 700;
    width: 180px;
    direction: ltr;
    text-align: left;
  }
  .base-field input:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
  }
  .btn-save-base {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 0.8rem 1.6rem;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 800;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    transition: all 0.2s;
  }
  .btn-save-base:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 40px rgba(16, 185, 129, 0.5);
  }
  .base-current {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(16, 185, 129, 0.2);
  }
  .base-current-item {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .base-current-label {
    font-size: 0.75rem;
    color: #a7f3d0;
    font-weight: 600;
  }
  .base-current-value {
    font-size: 1.3rem;
    font-weight: 900;
    color: #6ee7b7;
    font-family: monospace;
  }

  .info-box { 
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(29,78,216,0.1));
    border: 1px solid rgba(59,130,246,0.3); 
    border-radius: 14px; 
    padding: 1.2rem 1.5rem; 
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(59,130,246,0.1);
  }
  .info-box p { color: #93c5fd; font-size: 0.95rem; margin: 0; line-height: 1.7; }
  .card { 
    background: rgba(15,23,42,0.85);
    backdrop-filter: blur(16px);
    border-radius: 18px; 
    padding: 1.5rem 1.8rem; 
    border: 1px solid rgba(255,255,255,0.08); 
    margin-bottom: 1.5rem;
    box-shadow: 0 20px 50px rgba(0,0,0,.4);
  }
  .card-title { 
    font-size: 1.1rem; 
    font-weight: 800; 
    color: #93c5fd; 
    margin-bottom: 1.2rem; 
    display: flex; 
    align-items: center; 
    gap: 0.6rem; 
  }
  .add-form { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
  .field { display: flex; flex-direction: column; gap: 0.4rem; }
  .field label { font-size: 0.85rem; color: #93c5fd; font-weight: 600; }
  .field input, .field select { 
    background: rgba(30,41,59,0.8); 
    border: 1px solid rgba(59,130,246,0.3); 
    border-radius: 10px; 
    padding: 0.7rem 0.9rem; 
    color: #f1f5f9; 
    font-size: 0.95rem; 
    direction: rtl;
    transition: all 0.2s;
  }
  .field input:focus, .field select:focus { 
    outline: none; 
    border-color: #3b82f6;
    box-shadow: 0 0 12px rgba(59,130,246,0.3);
  }
  .btn-add { 
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
    color: white; 
    border: none; 
    padding: 0.7rem 1.4rem; 
    border-radius: 12px; 
    cursor: pointer; 
    font-size: 0.95rem; 
    font-weight: 700;
    box-shadow: 0 10px 30px rgba(59,130,246,0.4);
    transition: all 0.2s;
  }
  .btn-add:hover { 
    transform: translateY(-2px);
    box-shadow: 0 14px 35px rgba(59,130,246,0.5);
  }
  table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 0.8rem; }
  th, td { padding: 0.9rem 1rem; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.08); }
  th { color: #93c5fd; font-size: 0.85rem; font-weight: 700; background: rgba(30,41,59,0.5); }
  td { color: #f1f5f9; font-size: 0.95rem; }
  tbody tr { transition: background 0.15s; }
  tbody tr:nth-child(even) { background: rgba(15,23,42,0.5); }
  tbody tr:hover { background: rgba(59,130,246,0.12); }
  .price { font-family: monospace; direction: ltr; text-align: left; color: #34d399; font-weight: 700; }
  .status-active { color: #34d399; font-weight: 600; }
  .status-inactive { color: #f87171; font-weight: 600; }
  .badge { padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.8rem; font-weight: 700; }
  .badge-supp { background: rgba(168, 85, 247, 0.25); color: #c4b5fd; }
  .badge-main { background: rgba(59, 130, 246, 0.25); color: #93c5fd; }
  .actions { display: flex; gap: 0.6rem; }
  .btn-edit, .btn-delete { 
    padding: 0.5rem 0.9rem; 
    border-radius: 8px; 
    border: none; 
    cursor: pointer; 
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .btn-edit { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; }
  .btn-delete { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
  .btn-edit:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
  .btn-delete:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(239,68,68,0.4); }
  .modal-overlay { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0; 
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 1000; 
    align-items: center; 
    justify-content: center; 
  }
  .modal-overlay.active { display: flex; }
  .modal { 
    background: rgba(15,23,42,0.95);
    backdrop-filter: blur(16px);
    border-radius: 20px; 
    padding: 2rem; 
    width: 90%; 
    max-width: 480px; 
    border: 1px solid rgba(59,130,246,0.2);
    box-shadow: 0 25px 60px rgba(0,0,0,.5);
  }
  .modal-title { font-size: 1.2rem; font-weight: 800; color: #93c5fd; margin-bottom: 1.5rem; }
  .modal-form { display: flex; flex-direction: column; gap: 1.2rem; }
  .modal-form .field { width: 100%; }
  .modal-form .field input, .modal-form .field select { width: 100%; }
  .modal-actions { display: flex; gap: 1rem; margin-top: 1.2rem; }
  .btn-cancel { 
    background: rgba(30,41,59,0.8);
    border: 1px solid rgba(255,255,255,0.1);
    color: #94a3b8; 
    padding: 0.7rem 1.4rem; 
    border-radius: 10px; 
    cursor: pointer; 
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .btn-cancel:hover { background: rgba(51,65,85,0.8); color: #f1f5f9; }
  .btn-save { 
    background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
    color: white; 
    border: none; 
    padding: 0.7rem 1.4rem; 
    border-radius: 10px; 
    cursor: pointer; 
    font-size: 0.9rem; 
    font-weight: 700;
    box-shadow: 0 8px 20px rgba(59,130,246,0.4);
    transition: all 0.2s;
  }
  .btn-save:hover { transform: translateY(-1px); box-shadow: 0 12px 25px rgba(59,130,246,0.5); }
  .empty-state { text-align: center; padding: 3rem; color: #64748b; font-size: 1rem; }
  .checkbox-field { flex-direction: row; align-items: center; gap: 0.6rem; }
  .checkbox-field input[type="checkbox"] { 
    width: 20px; 
    height: 20px;
    accent-color: #3b82f6;
  }
  .debt-col { color: #fbbf24; font-weight: 700; font-family: monospace; }
</style>
  <style>
    /* Center table headers and cells for manager reports */
    table th, table td { text-align: center !important; }
  </style>
</head>
<body>
<div class="tariffs-page">
  <div class="page-header">
    <h1>ğŸ¥ ØªØ¹Ø±ÙÙ‡ Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§</h1>
    <a href="{{ url_for('manager.tariffs_index') }}" class="btn-back">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>
      Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
    </a>
  </div>

  <!-- ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡ (Ø¢Ø²Ø§Ø¯) -->
  <div class="base-card">
    <div class="base-card-title">â­ ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡ (ÙˆÛŒØ²ÛŒØª Ø¢Ø²Ø§Ø¯)</div>
    <div class="base-card-subtitle">Ø§ÛŒÙ† Ù…Ø¨Ù„ØºØŒ ØªØ¹Ø±ÙÙ‡ Ø§ØµÙ„ÛŒ ÙˆÛŒØ²ÛŒØª Ø¨Ø¯ÙˆÙ† Ø¨ÛŒÙ…Ù‡ Ø§Ø³Øª. Ù…Ø¹ÙˆÙ‚Ø§Øª ÙˆÛŒØ²ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙØ§ÙˆØª Ø§ÛŒÙ† Ù…Ø¨Ù„Øº Ø¨Ø§ Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    
    <form method="post" class="base-form">
      <input type="hidden" name="action" value="set_base">
      <div class="base-field">
        <label>ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª Ù¾Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label>
        <input type="text" name="base_visit_price" value="{{ '{:,.0f}'.format(base_tariff.tariff_price|default(0)) if base_tariff else '' }}" placeholder="Ù…Ø«Ø§Ù„: 2,500,000">
      </div>
      <button type="submit" class="btn-save-base">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡</button>
    </form>
    
    {% if base_tariff %}
    <div class="base-current">
      <div class="base-current-item">
        <span class="base-current-label">ØªØ¹Ø±ÙÙ‡ ÙØ¹Ù„ÛŒ ÙˆÛŒØ²ÛŒØª</span>
        <span class="base-current-value">{{ '{:,}'.format(base_tariff.tariff_price|int) }} ØªÙˆÙ…Ø§Ù†</span>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="info-box">
    <p>ğŸ’¡ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª Ù‡Ø± Ø¨ÛŒÙ…Ù‡ (Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±) Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯. <strong>Ù…Ø¹ÙˆÙ‚Ù‡ ÙˆÛŒØ²ÛŒØª = ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡ - Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø±</strong></p>
    <p style="margin-top:0.5rem;">Ø§Ú¯Ø± Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ø±Ø§ Ù¾ÙˆØ´Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ ØªÛŒÚ© Â«Ù¾ÙˆØ´Ø´ Ù¾Ø±Ø³ØªØ§Ø±ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ú©Ù„ Ù…Ø¨Ù„Øº Ø®Ø¯Ù…Ø§Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ÙˆÙ‚Ù‡ Ø§Ø² Ø¨ÛŒÙ…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯.</p>
  </div>

  <div class="card">
    <div class="card-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ù‡ Ø¬Ø¯ÛŒØ¯</div>
    <form method="post" class="add-form">
      <input type="hidden" name="action" value="add">
      <div class="field">
        <label>Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡</label>
        <input type="text" name="insurance_type" placeholder="Ù…Ø«Ø§Ù„: ØªØ£Ù…ÛŒÙ† Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ" required style="width:160px;">
      </div>
      <div class="field">
        <label>ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª / Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input type="text" name="tariff_price" placeholder="Ù…Ø«Ø§Ù„: 400,000" required style="width:140px;">
      </div>
      <div class="field checkbox-field" style="margin-bottom:0.3rem;">
        <input type="checkbox" name="nursing_covers" value="1" id="add-nursing">
        <label for="add-nursing">Ù¾ÙˆØ´Ø´ Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</label>
      </div>
      <div class="field checkbox-field" style="margin-bottom:0.3rem;">
        <input type="checkbox" name="is_supplementary" value="1" id="add-supp">
        <label for="add-supp">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
      </div>
      <button type="submit" class="btn-add">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
    </form>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“‹ Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§</div>
    {% if tariffs %}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡</th>
          <th>Ù†ÙˆØ¹</th>
          <th>Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (ÙˆÛŒØ²ÛŒØª)</th>
          <th>Ù¾ÙˆØ´Ø´ Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</th>
          <th>Ù…Ø¹ÙˆÙ‚Ù‡ ÙˆÛŒØ²ÛŒØª</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tariffs %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ t.insurance_type }}</td>
          <td>
            {% if t.is_supplementary %}
            <span class="badge badge-supp">ØªÚ©Ù…ÛŒÙ„ÛŒ</span>
            {% else %}
            <span class="badge badge-main">Ù¾Ø§ÛŒÙ‡</span>
            {% endif %}
          </td>
          <td class="price">{{ '{:,}'.format(t.tariff_price|int) }}</td>
          <td>
            {% if t.nursing_covers %}
            <span class="status-active">âœ“ Ø¨Ù„Ù‡</span>
            {% else %}
            <span class="status-inactive">âœ— Ø®ÛŒØ±</span>
            {% endif %}
          </td>
          <td class="debt-col">
            {% if base_tariff %}
              {{ '{:,}'.format((base_tariff.tariff_price - t.tariff_price)|int) }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if t.is_active %}
            <span class="status-active">âœ“ ÙØ¹Ø§Ù„</span>
            {% else %}
            <span class="status-inactive">âœ— ØºÛŒØ±ÙØ¹Ø§Ù„</span>
            {% endif %}
          </td>
          <td class="actions">
            <button type="button" class="btn-edit" onclick="openExclusionsModal('{{ t.insurance_type }}')">âš™ï¸ Ø§Ø³ØªØ«Ù†Ø§Ù‡Ø§</button>
            <button type="button" class="btn-edit" onclick="openEditModal({{ t.id }}, '{{ t.insurance_type }}', {{ t.tariff_price }}, {{ t.nursing_covers or 0 }}, {{ t.is_active }}, {{ t.is_supplementary }})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <form method="post" style="display:inline;" onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¨ÛŒÙ…Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');">
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="tariff_id" value="{{ t.id }}">
              <button type="submit" class="btn-delete">Ø­Ø°Ù</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">Ù‡ÛŒÚ† Ø¨ÛŒÙ…Ù‡â€ŒØ§ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
    {% endif %}
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÛŒÙ…Ù‡</div>
    <form method="post" class="modal-form">
      <input type="hidden" name="action" value="update">
      <input type="hidden" name="tariff_id" id="edit-id">
      <div class="field">
        <label>Ù†Ø§Ù… Ø¨ÛŒÙ…Ù‡</label>
        <input type="text" name="insurance_type" id="edit-name" required>
      </div>
      <div class="field">
        <label>ØªØ¹Ø±ÙÙ‡ ÙˆÛŒØ²ÛŒØª / Ø³Ù‡Ù… Ø¨ÛŒÙ…Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input type="text" name="tariff_price" id="edit-price" required>
      </div>
      <div class="field checkbox-field">
        <input type="checkbox" name="nursing_covers" id="edit-nursing" value="1">
        <label for="edit-nursing">Ù¾ÙˆØ´Ø´ Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</label>
      </div>
      <div class="field checkbox-field">
        <input type="checkbox" name="is_supplementary" id="edit-supp" value="1">
        <label for="edit-supp">Ø¨ÛŒÙ…Ù‡ ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
      </div>
      <div class="field checkbox-field">
        <input type="checkbox" name="is_active" id="edit-active" value="1">
        <label for="edit-active">ÙØ¹Ø§Ù„</label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeEditModal()">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="submit" class="btn-save">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
      </div>
    </form>
  </div>
</div>

<script>
function openEditModal(id, name, price, nursingCovers, isActive, isSupp) {
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-name').value = name;
  document.getElementById('edit-price').value = price;
  document.getElementById('edit-nursing').checked = nursingCovers == 1;
  document.getElementById('edit-active').checked = isActive == 1;
  document.getElementById('edit-supp').checked = isSupp == 1;
  document.getElementById('editModal').classList.add('active');
}
function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
}
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) closeEditModal();
});
</script>
<!-- Exclusions Modal -->
<div class="modal-overlay" id="exclusionsModal">
  <div class="modal" style="max-width:800px;">
    <div class="modal-title">ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª Ù¾ÙˆØ´Ø´ Ù¾Ø±Ø³ØªØ§Ø±ÛŒ</div>
    <div style="padding:0 0 1rem 0; color:#9ca3af;">Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø®Ø¯Ù…Øª Ù¾Ø±Ø³ØªØ§Ø±ÛŒ Ú©Ù‡ Ø¨ÛŒÙ…Ù‡ Ù¾ÙˆØ´Ø´ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ ØªÛŒÚ© Ø¨Ø²Ù†ÛŒØ¯.</div>
    <div id="exclusions-content" style="max-height:420px;overflow:auto;padding:0 1rem;">
      <div style="text-align:center;color:#64748b;padding:1rem;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end;padding:1rem;">
      <button class="btn-cancel" onclick="closeExclusionsModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn-save" onclick="saveExclusions()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª</button>
    </div>
  </div>
</div>

<script>
  let currentExInsurance = null;
  async function openExclusionsModal(insuranceType){
    currentExInsurance = insuranceType;
    const modal = document.getElementById('exclusionsModal');
    const content = document.getElementById('exclusions-content');
    modal.classList.add('active');
    content.innerHTML = '<div style="text-align:center;padding:1rem;color:#94a3b8;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
    try{
      const resp = await fetch(`/manager/insurance/${encodeURIComponent(insuranceType)}/nursing_exclusions`, {credentials:'same-origin'});
      if(!resp.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø®Ø¯Ù…Ø§Øª');
      const data = await resp.json();
      const services = data.services || [];
      // Build checklist
      const html = [`<div style="display:flex;flex-direction:column;gap:0.4rem;padding:0.6rem;">`];
      services.forEach(s => {
        html.push(`<label style="display:flex;align-items:center;gap:0.6rem;padding:.4rem;border-bottom:1px solid rgba(255,255,255,0.03);">
          <input type="checkbox" data-service-id="${s.id}" ${s.excluded? 'checked':''} />
          <div style="flex:1;"><strong style="color:#e5e7eb;">${s.service_name}</strong><div style="font-size:0.85rem;color:#9ca3af;">Ù‚ÛŒÙ…Øª: ${s.unit_price? s.unit_price : 'â€”'}</div></div>
        </label>`);
      });
      html.push('</div>');
      content.innerHTML = html.join('');
    }catch(e){
      console.error(e);
      content.innerHTML = `<div style="padding:1rem;color:#ef4444;">${e.message}</div>`;
    }
  }
  function closeExclusionsModal(){ document.getElementById('exclusionsModal').classList.remove('active'); }
  async function saveExclusions(){
    if(!currentExInsurance) return alert('Ø¨ÛŒÙ…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
    const content = document.getElementById('exclusions-content');
    const ids = Array.from(content.querySelectorAll('input[type="checkbox"]')).filter(ch=>ch.checked).map(ch=>parseInt(ch.dataset.serviceId,10));
    try{
      const resp = await fetch(`/manager/insurance/${encodeURIComponent(currentExInsurance)}/nursing_exclusions`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({service_ids: ids})
      });
      const data = await resp.json();
      if(!resp.ok || data.error){ throw new Error(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡'); }
      alert('Ø§Ø³ØªØ«Ù†Ø§Ø¦Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
      closeExclusionsModal();
    }catch(e){ console.error(e); alert(e.message || 'Ø®Ø·Ø§'); }
  }
  document.getElementById('exclusionsModal').addEventListener('click', function(e){ if(e.target === this) closeExclusionsModal(); });
</script>
</body>
</html>
