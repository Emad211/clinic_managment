<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§ - Ù…Ø¯ÛŒØ±ÛŒØª</title>
  <link href="{{ url_for('static', filename='css/vazirmatn.css') }}" rel="stylesheet" type="text/css" />
  <style>
    *{box-sizing:border-box;}
    body{font-family:'Vazirmatn',sans-serif;background:linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);color:#e5e7eb;margin:0;padding:2rem;min-height:100vh;}
    .wrap{max-width:1500px;margin:0 auto;}
    h1{margin:0;font-size:1.6rem;font-weight:900;display:flex;align-items:center;gap:.6rem;color:#f1f5f9;}
    .card{background:rgba(15,23,42,0.85);backdrop-filter:blur(16px);border-radius:18px;border:1px solid rgba(255,255,255,0.08);padding:1.4rem 1.6rem;margin-bottom:1.2rem;box-shadow:0 20px 50px rgba(0,0,0,.4);}
    .filters{display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;}
    .field{display:flex;flex-direction:column;gap:.3rem;min-width:150px;}
    label{font-size:.85rem;font-weight:700;color:#a5b4fc;}
    select,input{padding:.55rem .7rem;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:rgba(30,41,59,0.8);color:#e5e7eb;font-family:inherit;font-size:.95rem;transition:all 0.2s;}
    select:focus,input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 12px rgba(139,92,246,0.3);}
    .date-row{display:flex;gap:.3rem;align-items:center;}
    .date-select{padding:.45rem .5rem;border-radius:8px;border:1px solid rgba(139,92,246,0.3);background:rgba(30,41,59,0.8);color:#e5e7eb;font-family:inherit;font-size:.9rem;}
    .year-select{min-width:85px;}
    .quick-range{display:flex;gap:.5rem;flex-wrap:wrap;}
    .chip{padding:.5rem .9rem;border-radius:999px;border:1px solid rgba(139,92,246,0.4);background:rgba(30,41,59,0.7);color:#e5e7eb;font-size:.85rem;font-weight:700;cursor:pointer;transition:all 0.2s;}
    .chip:hover{border-color:#a78bfa;background:rgba(139,92,246,0.2);}
    .chip.active{background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-color:#a855f7;box-shadow:0 4px 15px rgba(139,92,246,0.4);}
    .btn-main{padding:.7rem 1.4rem;border-radius:12px;border:none;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;font-weight:800;font-size:.95rem;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;box-shadow:0 10px 30px rgba(236,72,153,.4);transition:all 0.2s;}
    .btn-main:hover{transform:translateY(-2px);box-shadow:0 14px 35px rgba(236,72,153,.5);}
    .summary{display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem;}
    .sum-box{flex:1 1 180px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(236,72,153,0.1));border-radius:14px;border:1px solid rgba(139,92,246,0.2);padding:.9rem 1.1rem;}
    .sum-label{font-size:.85rem;color:#a5b4fc;font-weight:600;margin-bottom:.3rem;}
    .sum-value{font-size:1.3rem;font-weight:900;color:#f1f5f9;}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:.6rem;}
    th,td{padding:.75rem .8rem;font-size:1rem;border-bottom:1px solid rgba(255,255,255,0.08);text-align:right;}
    th{background:rgba(30,41,59,0.9);color:#a5b4fc;font-weight:700;position:sticky;top:0;z-index:1;font-size:.95rem;}
    tbody tr{transition:background 0.15s;}
    tbody tr:nth-child(even){background:rgba(15,23,42,0.5);}
    tbody tr:hover{background:rgba(139,92,246,0.15);}
    .badge{display:inline-block;padding:.25rem .65rem;border-radius:999px;font-size:.85rem;font-weight:700;}
    .badge-ins{background:rgba(29,78,216,0.3);color:#93c5fd;}
    .badge-shift{background:rgba(15,118,110,0.3);color:#5eead4;}
    .badge-doc{background:rgba(124,45,18,0.3);color:#fdba74;}
    .note-cell{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;}
    .btn-back{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.2rem;border-radius:12px;background:rgba(30,41,59,0.8);border:1px solid rgba(139,92,246,0.3);color:#a5b4fc;font-size:.9rem;font-weight:700;text-decoration:none;transition:all 0.2s;}
    .btn-back:hover{background:rgba(139,92,246,0.2);border-color:#8b5cf6;color:#f1f5f9;transform:translateX(4px);}
    .btn-back svg{width:18px;height:18px;}
    /* Center table headers and cells for manager reports */
    table th, table td { text-align: center !important; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top-bar">
    <h1>ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§</h1>
    <a href="{{ url_for('manager.reports') }}" class="btn-back">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"/></svg>
      Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±Ú©Ø² Ú¯Ø²Ø§Ø±Ø´Ø§Øª
    </a>
  </div>

  <div class="card">
    <form method="get" class="filters">
      <div class="field">
        <label>Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
        <div class="date-row">
          <select id="from-day" class="date-select"></select>
          <span>/</span>
          <select id="from-month" class="date-select"></select>
          <span>/</span>
          <select id="from-year" class="date-select year-select"></select>
        </div>
        <input type="hidden" name="from" id="from-date-hidden" value="{{ active_filters.from or '' }}">
      </div>
      <div class="field">
        <label>ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
        <div class="date-row">
          <select id="to-day" class="date-select"></select>
          <span>/</span>
          <select id="to-month" class="date-select"></select>
          <span>/</span>
          <select id="to-year" class="date-select year-select"></select>
        </div>
        <input type="hidden" name="to" id="to-date-hidden" value="{{ active_filters.to or '' }}">
      </div>
      <div class="field">
        <label>Ù¾Ø²Ø´Ú©</label>
        <select name="doctor_id">
          <option value="">Ù‡Ù…Ù‡</option>
          {% for d in doctors %}
          <option value="{{ d.id }}" {% if active_filters.doctor_id == d.id %}selected{% endif %}>{{ d.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Ø¨ÛŒÙ…Ù‡</label>
        <select name="insurance_type">
          <option value="">Ù‡Ù…Ù‡</option>
          {% for ins in insurances %}
          <option value="{{ ins.insurance_type }}" {% if active_filters.insurance_type == ins.insurance_type %}selected{% endif %}>{{ ins.insurance_type }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Ù¾Ø°ÛŒØ±Ø´</label>
        <select name="reception_user">
          <option value="">Ù‡Ù…Ù‡</option>
          {% for u in users %}
          <option value="{{ u.username }}" {% if active_filters.reception_user == u.username %}selected{% endif %}>{{ u.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Ø´ÛŒÙØª</label>
        <select name="shift">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="morning" {% if active_filters.shift == 'morning' %}selected{% endif %}>ØµØ¨Ø­</option>
          <option value="evening" {% if active_filters.shift == 'evening' %}selected{% endif %}>Ø¹ØµØ±</option>
          <option value="night" {% if active_filters.shift == 'night' %}selected{% endif %}>Ø´Ø¨</option>
        </select>
      </div>
      <div class="field">
        <label>Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹</label>
        <div class="quick-range">
          <span class="chip" onclick="setQuickRange('today', this)">Ø§Ù…Ø±ÙˆØ²</span>
          <span class="chip" onclick="setQuickRange('r7', this)">Û· Ø±ÙˆØ²Ù‡</span>
          <span class="chip" onclick="setQuickRange('r30', this)">Û³Û° Ø±ÙˆØ²Ù‡</span>
          <span class="chip" onclick="setQuickRange('r90', this)">Û¹Û° Ø±ÙˆØ²Ù‡</span>
        </div>
      </div>
      <div class="field" style="margin-inline-start:auto;">
        <button type="submit" class="btn-main">ğŸ” Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
      </div>
    </form>

    <div class="summary">
      <div class="sum-box">
        <div class="sum-label">ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ²ÛŒØª</div>
        <div class="sum-value">{{ total_visits }}</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Ø¬Ù…Ø¹ Ù…Ø¨Ø§Ù„Øº (ØªÙˆÙ…Ø§Ù†)</div>
        <div class="sum-value">{{ '{:,}'.format((total_amount or 0)|int) }}</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† ÛŒÚ©ØªØ§</div>
        <div class="sum-value">{{ unique_patients }}</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:1.2rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;flex-wrap:wrap;gap:.5rem;">
      <div style="font-size:.95rem;font-weight:800;">Ù„ÛŒØ³Øª ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§</div>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <a href="{{ url_for('manager.export_visits_csv', **active_filters) }}" class="btn-main" style="background:#059669;box-shadow:none;font-size:.75rem;padding:.4rem .8rem;">ğŸ“¥ CSV</a>
        <button type="button" onclick="printReport()" class="btn-main" style="background:#6366f1;box-shadow:none;font-size:.75rem;padding:.4rem .8rem;">ğŸ–¨ Ú†Ø§Ù¾/PDF</button>
        <span style="font-size:.75rem;color:#9ca3af;">{{ visits|length }} Ø±Ú©ÙˆØ±Ø¯</span>
      </div>
    </div>
    <div style="max-height:60vh;overflow:auto;" id="printArea">
      <table>
        <thead>
          <tr>
            <th>Ø²Ù…Ø§Ù†</th>
            <th>Ø¨ÛŒÙ…Ø§Ø±</th>
            <th>Ø¨ÛŒÙ…Ù‡</th>
            <th>Ù¾Ø²Ø´Ú©</th>
            <th>Ù¾Ø°ÛŒØ±Ø´</th>
            <th>Ø´ÛŒÙØª</th>
            <th>Ù…Ø¨Ù„Øº</th>
            <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
          </tr>
        </thead>
        <tbody>
        {% for r in visits %}
          <tr>
            <td>{{ r.visit_date | jalali_datetime }}</td>
            <td>{{ r.patient_name }}</td>
            <td>
              <span class="badge badge-ins">{{ r.insurance_type or 'Ø¢Ø²Ø§Ø¯' }}</span>
              {% if r.supplementary_insurance %}<span class="badge" style="background:#4b5563;color:#e5e7eb;">{{ r.supplementary_insurance }}</span>{% endif %}
            </td>
            <td><span class="badge badge-doc">{{ r.doctor_name or 'â€”' }}</span></td>
            <td>{{ r.reception_user or 'â€”' }}</td>
            <td><span class="badge badge-shift">{{ 'ØµØ¨Ø­' if r.shift=='morning' else ('Ø¹ØµØ±' if r.shift=='evening' else 'Ø´Ø¨' if r.shift=='night' else 'â€”') }}</span></td>
            <td>{{ '{:,}'.format((r.total_amount or 0)|int) }}</td>
            <td class="note-cell" title="{{ r.notes }}">{{ r.notes or 'â€”' }}</td>
          </tr>
        {% endfor %}
        {% if not visits %}
          <tr><td colspan="8" style="text-align:center;color:#6b7280;padding:1.5rem;">Ù‡ÛŒÚ† ÙˆÛŒØ²ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ±Ù‡Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  const JALALI_RANGES = {{ jalali_ranges | tojson | safe }};

  function toPersianNum(num) {
    const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
    return String(num).replace(/\d/g, d => persianDigits[d]);
  }

  const BASE_JALALI_YEAR = JALALI_RANGES.today.y;

  function populateDateSelects() {
    const currentYear = BASE_JALALI_YEAR;

    // days
    ['from-day','to-day'].forEach(id => {
      const sel = document.getElementById(id);
      if(!sel) return;
      sel.innerHTML = '';
      for(let d=1; d<=31; d++){
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = toPersianNum(d);
        sel.appendChild(opt);
      }
    });

    // months
    const monthNames = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
    ['from-month','to-month'].forEach(id => {
      const sel = document.getElementById(id);
      if(!sel) return;
      sel.innerHTML = '';
      monthNames.forEach((name,idx) => {
        const opt = document.createElement('option');
        opt.value = idx+1;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    });

    // years (current .. current-10)
    ['from-year','to-year'].forEach(id => {
      const sel = document.getElementById(id);
      if(!sel) return;
      sel.innerHTML = '';
      for(let y=currentYear; y>=currentYear-10; y--){
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = toPersianNum(y);
        sel.appendChild(opt);
      }
    });

    // initial range: if URL has from/to, respect them, else 7-day
    const fromHidden = document.getElementById('from-date-hidden').value;
    const toHidden = document.getElementById('to-date-hidden').value;
    if(fromHidden && toHidden){
      applyHiddenToSelects(fromHidden, 'from');
      applyHiddenToSelects(toHidden, 'to');
    } else {
      setQuickRange('r7');
    }
  }

  function applyHiddenToSelects(value, prefix){
    const parts = value.split('/');
    if(parts.length !== 3) return;
    document.getElementById(prefix+'-year').value = parseInt(parts[0],10);
    document.getElementById(prefix+'-month').value = parseInt(parts[1],10);
    document.getElementById(prefix+'-day').value = parseInt(parts[2],10);
  }

  function syncHiddenDates(){
    const yFrom = document.getElementById('from-year').value;
    const mFrom = String(document.getElementById('from-month').value).padStart(2,'0');
    const dFrom = String(document.getElementById('from-day').value).padStart(2,'0');
    const yTo = document.getElementById('to-year').value;
    const mTo = String(document.getElementById('to-month').value).padStart(2,'0');
    const dTo = String(document.getElementById('to-day').value).padStart(2,'0');
    document.getElementById('from-date-hidden').value = `${yFrom}/${mFrom}/${dFrom}`;
    document.getElementById('to-date-hidden').value = `${yTo}/${mTo}/${dTo}`;
  }

  function setQuickRange(key, chipEl){
    const range = JALALI_RANGES[key];
    if(!range) return;
    const f = range.from, t = range.to;
    document.getElementById('from-year').value = f.y;
    document.getElementById('from-month').value = f.m;
    document.getElementById('from-day').value = f.d;
    document.getElementById('to-year').value = t.y;
    document.getElementById('to-month').value = t.m;
    document.getElementById('to-day').value = t.d;
    syncHiddenDates();
    if(chipEl){
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chipEl.classList.add('active');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    populateDateSelects();
    ['from-day','from-month','from-year','to-day','to-month','to-year'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener('change', syncHiddenDates);
    });
  });

  function printReport(){
    const content = document.getElementById('printArea').innerHTML;
    const win = window.open('', '_blank');
    win.document.write(`
      <!doctype html>
      <html lang="fa" dir="rtl">
      <head>
        <meta charset="utf-8">
        <title>Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§</title>
        <link href="{{ url_for('static', filename='css/vazirmatn.css') }}" rel="stylesheet" type="text/css" />
        <style>
          *{box-sizing:border-box;}
          body{font-family:'Vazirmatn',sans-serif;padding:1rem;direction:rtl;}
          table{width:100%;border-collapse:collapse;font-size:11px;}
          th,td{border:1px solid #333;padding:6px;text-align:right;}
          th{background:#eee;}
          h2{text-align:center;margin-bottom:1rem;}
          .badge{padding:2px 6px;border-radius:4px;font-size:10px;}
          @media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}
        </style>
      </head>
      <body>
        <h2>Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§</h2>
        ${content}
        <script>window.onload=()=>{window.print();}<\/script>
      </body>
      </html>
    `);
    win.document.close();
  }
</script>
</body>
</html>
